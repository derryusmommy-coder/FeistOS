<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FeistOS v0.053 - Alpha</title>
    <style>
        /* ========================================= */
        /* --- –°–¢–ò–õ–ò (–ì–†–ê–§–ò–ö–ê –ò–ó –¢–í–û–ï–ì–û –§–ê–ô–õ–ê) --- */
        /* ========================================= */
        :root {
            --primary-color: #33ff33;
            --selection-color: rgba(0, 120, 215, 0.4);
            --selection-border: rgba(0, 120, 215, 0.8);
            --icon-hover-bg: rgba(255, 255, 255, 0.15);
            --icon-selected-bg: rgba(0, 120, 215, 0.4);
            --taskbar-bg: rgba(20, 20, 20, 0.7);
            --window-bg: #f5f5f5;
            --start-menu-bg: rgba(30, 30, 30, 0.85);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
            background-color: #000;
        }

        /* ========================================= */
        /* --- –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò (IMPROVED GRAPHICS) --- */
        /* ========================================= */
        #boot-screen {
            font-family: 'Courier New', monospace;
            /* –ì–ª—É–±–æ–∫–∏–π —Ä–∞–¥–∏–∞–ª—å–Ω—ã–π —Ñ–æ–Ω –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —á–µ—Ä–Ω–æ–≥–æ */
            background: radial-gradient(circle at center, #1a2a1a 0%, #000000 100%);
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-out;
            overflow: hidden;
        }

        /* –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ç–∫—É –ø–æ–≤–µ—Ä—Ö —ç–∫—Ä–∞–Ω–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –º–æ–Ω–∏—Ç–æ—Ä–∞ */
        #boot-screen::before {
            content: "";
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15) 0px,
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 1;
        }

        .os-logo {
            font-size: 4rem; 
            font-weight: 900; 
            margin-bottom: 30px;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 5px;
            position: relative;
            /* –ú–æ—â–Ω–æ–µ –Ω–µ–æ–Ω–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
            text-shadow: 
                0 0 10px var(--primary-color),
                0 0 20px var(--primary-color),
                0 0 40px var(--primary-color);
            animation: logoPulse 2s infinite alternate, glitch 3s infinite;
        }

        .os-logo span {
            font-size: 1.2rem;
            letter-spacing: 2px;
            opacity: 0.8;
            vertical-align: middle;
            text-shadow: none;
            background: rgba(0,0,0,0.5);
            padding: 2px 5px;
            border-radius: 4px;
        }

        /* –ö–æ–Ω—Å–æ–ª—å –ª–æ–≥–æ–≤ */
        .boot-log {
            width: 500px; 
            height: 100px; 
            font-size: 0.85rem; 
            color: rgba(255, 255, 255, 0.7);
            background: rgba(0, 20, 0, 0.3); /* –¢–µ–º–Ω–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ */
            overflow: hidden; 
            text-align: left; 
            margin-bottom: 20px;
            border-left: 2px solid var(--primary-color); 
            padding: 10px 15px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            font-family: 'Consolas', monospace;
            z-index: 2;
        }

        .boot-log div {
            margin-bottom: 4px;
            text-shadow: 0 0 2px black;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
        .progress-container {
            width: 500px; 
            height: 6px; 
            background-color: #111;
            border: 1px solid #333;
            border-radius: 10px; 
            overflow: hidden; 
            box-shadow: 0 0 10px #000;
            position: relative;
            z-index: 2;
        }

        /* –°–∞–º–∞ –ø–æ–ª–æ—Å–∞ (—Ç–µ–ø–µ—Ä—å –ø–æ–ª–æ—Å–∞—Ç–∞—è –∏ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è) */
        .progress-bar {
            width: 0%; 
            height: 100%; 
            background: var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color); 
            transition: width 0.1s linear;
            position: relative;
        }
        
        /* –ë–ª–∏–∫ –Ω–∞ –∫–æ–Ω—Ü–µ –ø–æ–ª–æ—Å—ã */
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0;
            width: 5px;
            background: #fff;
            box-shadow: 0 0 10px #fff;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes logoPulse {
            0% { text-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color); opacity: 0.9; }
            100% { text-shadow: 0 0 20px var(--primary-color), 0 0 40px var(--primary-color), 0 0 60px var(--primary-color); opacity: 1; }
        }

        @keyframes glitch {
            0% { transform: skew(0deg); }
            20% { transform: skew(0deg); }
            21% { transform: skew(-2deg); }
            22% { transform: skew(2deg); }
            23% { transform: skew(0deg); }
            100% { transform: skew(0deg); }
        }

        /* --- –†–ê–ë–û–ß–ò–ô –°–¢–û–õ --- */
        #desktop {
            display: none; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #2b4162 0%, #12100e 100%);
            position: relative; overflow: hidden;
        }

        /* --- –ò–ö–û–ù–ö–ò (TE–ü–ï–†–¨ ABSOLUTE) --- */
        .icon {
            width: 80px;
            position: absolute; /* –í–∞–∂–Ω–æ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è */
            padding: 10px 5px;
            text-align: center; cursor: default; color: #eee;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            border: 1px solid transparent; border-radius: 5px;
            display: flex; flex-direction: column; align-items: center;
            transition: background-color 0.1s, border-color 0.1s;
        }

        .icon:hover { background-color: var(--icon-hover-bg); border-color: rgba(255,255,255,0.2); }
        .icon.selected { background-color: var(--icon-selected-bg); border-color: var(--selection-border); }

        .icon-visual {
            width: 48px; height: 48px; margin-bottom: 8px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold; color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); position: relative; overflow: hidden;
        }
        
        .icon-visual::after {
             content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%;
             background: linear-gradient(rgba(255,255,255,0.4), transparent);
        }

        /* –¶–≤–µ—Ç–∞ –∏–∫–æ–Ω–æ–∫ */
        .icon-visual.sys { background: linear-gradient(135deg, #3498db, #2c3e50); }
        .icon-visual.doc { background: linear-gradient(135deg, #f1c40f, #d35400); }
        .icon-visual.app { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .icon-visual.set { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .icon-visual.bin { background: linear-gradient(135deg, #7f8c8d, #34495e); }

        .icon span {
            font-size: 0.85rem; max-width: 100%; overflow: hidden;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            pointer-events: none; /* –¢–µ–∫—Å—Ç –Ω–µ –º–µ—à–∞–µ—Ç –∫–ª–∏–∫–∞–º */
        }

        /* --- –û–ö–ù–ê (WINDOWS) --- */
        .window {
            position: absolute;
            background-color: var(--window-bg);
            border-radius: 6px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            display: flex; flex-direction: column;
            border: 1px solid #777;
            /* –ò–ó–ú–ï–ù–ï–ù–ò–Ø –î–õ–Ø –†–ê–°–¢–Ø–ì–ò–í–ê–ù–ò–Ø: */
            resize: both;       /* –†–∞–∑—Ä–µ—à–∞–µ–º –º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä */
            overflow: hidden;   /* –°–∫—Ä—ã–≤–∞–µ–º –ª–∏—à–Ω–µ–µ */
            min-width: 300px; min-height: 200px;
            animation: popIn 0.2s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        /* –î–æ–±–∞–≤–ª—è–µ–º –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —É–≥–æ–ª–∫–∞ (–≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö —É–≥–æ–ª–æ–∫ –º–æ–∂–µ—Ç –ø—Ä—è—Ç–∞—Ç—å—Å—è) */
        .window::-webkit-resizer {
            background-color: transparent;
        }
        
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .window-header {
            height: 32px;
            background: linear-gradient(to bottom, #e6e6e6, #dcdcdc);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; border-bottom: 1px solid #aaa;
            cursor: default; user-select: none;
        }
        
        .window-title { font-size: 13px; font-weight: 600; color: #333; }
        
        .window-controls button {
            width: 24px; height: 24px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 14px; margin-left: 5px;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-close { background: #ff5f57; color: white; }
        .btn-close:hover { background: #c0392b; }

        .window-content { flex: 1; position: relative; background: white; overflow: auto; }

        /* –°—Ç–∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π */
        /* –ë—Ä–∞—É–∑–µ—Ä */
        .browser-bar { display: flex; padding: 5px; background: #eee; border-bottom: 1px solid #ccc; }
        .browser-bar input { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 3px; margin-right: 5px; }
        .browser-bar button { padding: 5px 15px; cursor: pointer; }
        iframe { width: 100%; height: 100%; border: none; display: block; }
        
        /* –ö–æ—Ä–∑–∏–Ω–∞/–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ */
        .file-list { padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, 70px); gap: 10px; }
        .file-item { text-align: center; cursor: pointer; }
        .file-icon { width: 40px; height: 40px; background: #ddd; margin: 0 auto 5px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #555; }
        .file-name { font-size: 11px; color: #333; }

/* --- –ú–ï–ù–Æ –ü–£–°–ö (WINDOWS 11 STYLE) --- */
        #start-menu {
            position: absolute;
            bottom: 60px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –ø–∞–Ω–µ–ª–∏ –∑–∞–¥–∞—á */
            left: 50%;
            transform: translateX(-50%); /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
            width: 600px;
            height: 650px;
            background-color: rgba(30, 30, 30, 0.85); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            display: none;
            flex-direction: column;
            z-index: 10001;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            padding: 25px;
            box-sizing: border-box;
            animation: slideUpWin11 0.3s cubic-bezier(0.1, 0.9, 0.2, 1) forwards;
        }

        @keyframes slideUpWin11 {
            0% { opacity: 0; transform: translate(-50%, 40px); }
            100% { opacity: 1; transform: translate(-50%, 0); }
        }

        .start-search-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 10px 15px;
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: flex; align-items: center; gap: 10px;
            border-bottom: 2px solid transparent;
            transition: 0.2s;
        }
        .start-search-box:hover { background: rgba(255, 255, 255, 0.05); }

        .start-section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding: 0 10px;
        }
        .start-section-title { font-weight: 600; font-size: 0.9rem; }
        .start-section-btn { 
            background: none; border: none; color: #fff; opacity: 0.7; font-size: 0.8rem; 
            cursor: pointer; padding: 2px 8px; border-radius: 4px;
        }
        .start-section-btn:hover { background: rgba(255,255,255,0.1); }

        .start-pinned-grid {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px;
            margin-bottom: 30px; padding: 0 10px;
        }
        
        .pinned-app {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            cursor: pointer; padding: 10px 5px; border-radius: 4px; transition: 0.2s;
        }
        .pinned-app:hover { background: rgba(255, 255, 255, 0.05); }
        .pinned-app:active { transform: scale(0.95); }
        
        .pinned-icon {
            width: 32px; height: 32px; background: #444; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .pinned-name { font-size: 11px; text-align: center; color: #eee; }

        .start-rec-list {
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 0 10px;
        }

        .rec-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px; border-radius: 4px; cursor: pointer; transition: 0.2s;
        }
        .rec-item:hover { background: rgba(255, 255, 255, 0.05); }
        .rec-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; border-radius: 3px; }
        .rec-info { display: flex; flex-direction: column; }
        .rec-name { font-size: 12px; font-weight: 500; }
        .rec-time { font-size: 10px; color: #aaa; }

        .start-footer {
            margin-top: auto; padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; justify-content: space-between; align-items: center;
            padding-left: 15px; padding-right: 15px;
        }

        .user-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px 10px; border-radius: 4px; transition: 0.2s; }
        .user-profile:hover { background: rgba(255,255,255,0.1); }
        
        .power-btn {
            background: none; border: none; color: #fff;
            width: 36px; height: 36px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer; transition: 0.2s;
        }
        .power-btn:hover { background: rgba(255,255,255,0.1); color: #ff5f57; }

        /* --- –ü–ê–ù–ï–õ–¨ –ó–ê–î–ê–ß --- */
        .taskbar {
            position: absolute; bottom: 0; width: 100%; height: 45px;
            background-color: var(--taskbar-bg);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; box-sizing: border-box;
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 10000;
        }

        .start-btn {
            background: linear-gradient(to bottom, #444, #222);
            color: #eee; padding: 6px 20px; font-weight: bold;
            border: 1px solid #555; border-radius: 3px; cursor: pointer;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
            display: flex; align-items: center; gap: 5px;
        }
        .start-btn::before { content: '‚óà'; color: var(--primary-color); font-size: 1.2rem; }
        .start-btn:hover { background: linear-gradient(to bottom, #555, #333); box-shadow: 0 0 10px rgba(51, 255, 51, 0.3); }
        .start-btn.active { background: #555; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); }

/* --- –ù–û–í–´–ï –°–¢–ò–õ–ò: –ê–ö–¢–ò–í–ù–´–ï –ó–ê–î–ê–ß–ò --- */
        #taskbar-apps {
            flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ */
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 0 10px;
            overflow: hidden;
        }

        .taskbar-app {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.8rem;
            cursor: pointer;
            border: 1px solid transparent;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            transition: background 0.2s;
        }

        .taskbar-app:hover { background: rgba(255, 255, 255, 0.2); }
        .taskbar-app.active {
            background: rgba(255, 255, 255, 0.25);
            border-bottom: 2px solid var(--primary-color);
            color: white;
        }
        
        .btn-minimize { background: #f1c40f; color: black; }
        .btn-minimize:hover { background: #d4ac0d; }

        .clock-container {
            padding: 5px 15px; background-color: rgba(0,0,0,0.3);
            border-radius: 5px; border: 1px solid rgba(255,255,255,0.05); color: #eee; font-size: 0.9rem;
        }

        /* –†–∞–º–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è */
        #selection-box {
            position: absolute; background-color: var(--selection-color); border: 1px solid var(--selection-border);
            display: none; pointer-events: none; z-index: 8000;
        }

/* --- CRT REALITY ENGINE (WOW EFFECT) --- */
        .crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 3000000; /* –ü–æ–≤–µ—Ä—Ö –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å–µ–≥–æ */
            background: 
                /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç–∫–∏ */
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è RGB —Å–µ—Ç–∫–∞ (—Å—É–±–ø–∏–∫—Å–µ–ª–∏) */
                linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
            background-size: 100% 3px, 4px 100%;
            pointer-events: none; /* –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–ª–∏–∫–∏ —Å–∫–≤–æ–∑—å —Å–µ–±—è! */
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8); /* –°–∏–ª—å–Ω–∞—è –≤–∏–Ω—å–µ—Ç–∫–∞ */
            animation: flicker 0.15s infinite;
            mix-blend-mode: hard-light;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –º–µ—Ä—Ü–∞–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∞ */
        @keyframes flicker {
            0% { opacity: 0.96; }
            50% { opacity: 0.92; }
            100% { opacity: 0.96; }
        }

        /* –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç—É –∏ –ª–µ–≥–∫–∏–π —Å–¥–≤–∏–≥ –∫–∞–Ω–∞–ª–æ–≤ */
        body {
            text-shadow: 0 0 3px rgba(51, 255, 51, 0.4), 1px 0 0 rgba(255, 0, 0, 0.4), -1px 0 0 rgba(0, 0, 255, 0.4);
            filter: contrast(1.1) brightness(1.1);
        }

/* --- VIRUS & BSOD MODE --- */
        #bsod {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0000aa; color: white; font-family: 'Courier New', monospace;
            z-index: 2000000; padding: 10% 20%; box-sizing: border-box;
            font-size: 1.2rem; line-height: 1.5; cursor: none;
        }

        /* –°—Ç–∏–ª—å –∑–∞—Ä–∞–∂–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã */
        body.infected-mode {
            --primary-color: #ff0000;
            --selection-color: rgba(255, 0, 0, 0.4);
            --selection-border: rgba(255, 0, 0, 0.8);
            --taskbar-bg: rgba(50, 0, 0, 0.9);
            --window-bg: #2a0000;
        }

        body.infected-mode #desktop {
            background: radial-gradient(circle, #400000, #000000) !important;
        }
        
        body.infected-mode .icon { color: #ff3333; text-shadow: 0 0 5px #ff0000; }
        body.infected-mode .window-header { background: linear-gradient(to right, #900, #300); color: #fff; }
        body.infected-mode .start-btn { border-color: red; color: red; }
        body.infected-mode .start-btn::before { content: '‚ö†Ô∏è'; }

/* --- RECOVERY MODE & BIOS PASSWORD --- */
        #bios-password-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000088; color: white; z-index: 1000000;
            justify-content: center; align-items: center; flex-direction: column;
            font-family: 'Courier New', monospace;
        }

        #bios-input {
            background: #aaaaaa; color: black; border: 2px solid white;
            padding: 5px; font-family: inherit; font-weight: bold; width: 300px;
            text-transform: uppercase; outline: none; text-align: center;
        }

        #recovery-terminal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0d0d0d; color: #00ff00; font-family: 'Consolas', 'Courier New', monospace;
            z-index: 1000000; padding: 20px; box-sizing: border-box; font-size: 14px;
        }
        
        .term-line { margin-bottom: 5px; }
        .term-input-line { display: flex; color: #fff; }
        .term-caret { width: 10px; height: 18px; background: #00ff00; animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }

/* --- –ö–ê–°–¢–û–ú–ù–û–ï –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ --- */
        #custom-context-menu {
            display: none;
            position: absolute;
            background: #222;
            border: 1px solid #555;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
            z-index: 99999;
            width: 150px;
            font-family: 'Segoe UI', sans-serif;
        }

        .ctx-item {
            padding: 8px 15px;
            color: #eee;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.1s;
        }

        .ctx-item:hover {
            background: var(--primary-color);
            color: #000;
        }
        
        .ctx-separator {
            height: 1px; background: #444; margin: 2px 0;
        }

/* --- –°–¢–ò–õ–ò –ü–ê–ù–ï–õ–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø --- */
        .settings-layout {
            display: flex; height: 100%;
        }
        .settings-sidebar {
            width: 120px; background: #e0e0e0; border-right: 1px solid #ccc;
            display: flex; flex-direction: column; padding: 10px 0;
        }
        .settings-tab-btn {
            padding: 10px 15px; cursor: pointer; font-size: 13px; color: #333;
            transition: background 0.2s; text-align: left;
        }
        .settings-tab-btn:hover { background: #d0d0d0; }
        .settings-tab-btn.active {
            background: #fff; font-weight: bold; border-left: 3px solid var(--primary-color);
        }
        
        .settings-content-area {
            flex: 1; padding: 20px; overflow-y: auto; background: #f5f5f5;
        }
        .settings-section { display: none; animation: fadeIn 0.3s; }
        .settings-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .setting-group { margin-bottom: 20px; background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .setting-label { font-weight: bold; display: block; margin-bottom: 8px; font-size: 12px; color: #555; }
        
        .color-picker-btn {
            width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ddd;
            cursor: pointer; display: inline-block; margin-right: 5px; transition: transform 0.2s;
        }
        .color-picker-btn:hover { transform: scale(1.2); border-color: #999; }

        .bg-picker-item {
            width: 80px; height: 50px; border: 2px solid #ddd; display: inline-block;
            margin-right: 10px; cursor: pointer; border-radius: 4px;
        }
        .bg-picker-item:hover { border-color: var(--primary-color); }
        
        .st-input {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 3px;
            font-family: inherit; box-sizing: border-box;
        }
        
        .danger-btn {
            background: #e74c3c; color: white; border: none; padding: 8px 15px;
            border-radius: 3px; cursor: pointer; width: 100%; font-weight: bold;
        }
        .danger-btn:hover { background: #c0392b; }

/* --- –°–¢–ò–õ–ò –í–ò–†–£–°–ù–û–ì–û –≠–ö–†–ê–ù–ê --- */
        #virus-boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #050000;
            z-index: 100000; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            display: flex; align-items: center; justify-content: center;
            font-family: 'Courier New', monospace;
            background-image: linear-gradient(rgba(255, 0, 0, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 0, 0, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .virus-alert-box {
            width: 80%; max-width: 800px;
            border: 4px solid red;
            padding: 20px;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.5);
            background: rgba(20, 0, 0, 0.9);
            text-align: center;
        }

        .virus-title {
            color: red; font-size: 2.5rem; margin: 0 0 20px 0;
            text-shadow: 0 0 10px red;
            animation: blinkRed 0.5s infinite;
        }

        #virus-console {
            width: 100%; height: 300px; /* –í—ã—Å–æ–∫–∏–π –±–ª–æ–∫ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */
            background: black;
            color: #ff5555;
            border: 1px solid #550000;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto; /* –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –æ–æ–æ—á–µ–Ω—å –º–Ω–æ–≥–æ, –ø–æ—è–≤–∏—Ç—Å—è —Å–∫—Ä–æ–ª–ª */
            text-align: left;
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }
/* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ –≤–∏—Ä—É—Å–∞ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª –±–µ–ª—ã–º) */
        #virus-console::-webkit-scrollbar {
            width: 10px;
            background: #000; /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω —Ç—Ä–µ–∫–∞ */
        }
        
        #virus-console::-webkit-scrollbar-thumb {
            background: #900; /* –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π –ø–æ–ª–∑—É–Ω–æ–∫ */
            border: 1px solid #f00; /* –Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ */
        }

        #virus-console::-webkit-scrollbar-corner {
            background: #000;
        }

        .virus-progress {
            width: 100%; height: 20px; background: #300; border: 1px solid red;
        }
        #virus-bar {
            width: 0%; height: 100%; background: red; transition: width 0.1s;
            box-shadow: 0 0 10px red;
        }

        @keyframes blinkRed { 50% { opacity: 0.5; } }

    </style>
</head>
<body>
<canvas id="graffiti-layer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000000; pointer-events: none;"></canvas>
<div id="custom-context-menu">
        <div class="ctx-item" id="ctx-open">–û—Ç–∫—Ä—ã—Ç—å</div>
        <div class="ctx-separator"></div>
        <div class="ctx-item" id="ctx-delete" style="color:#ff5555;">–£–¥–∞–ª–∏—Ç—å</div>
    </div>

<div class="crt-overlay"></div>

<div id="bios-password-screen">
        <div style="border: 2px solid white; padding: 20px; text-align: center; background: #0000aa;">
            <p>SYSTEM INTERRUPT DETECTED</p>
            <p>ENTER KERNEL OVERRIDE CODE:</p>
            <br>
            <input type="text" id="bios-input" maxlength="20" autocomplete="off">
        </div>
    </div>

    <div id="recovery-terminal">
        <div id="term-output">
            <div class="term-line">FeistOS Recovery Console v1.0 [SAFE MODE]</div>
            <div class="term-line">Copyright (c) Feist Corp. All rights reserved.</div>
            <div class="term-line">------------------------------------------------</div>
            <div class="term-line">Mounted root filesystem [READ-ONLY]</div>
            <div class="term-line">Network disconnected for safety.</div>
            <div class="term-line"><br></div>
            <div class="term-line">Type 'help' for available commands.</div>
            <div class="term-line"><br></div>
        </div>
        <div class="term-input-line">
            <span>root@recovery:~#&nbsp;</span>
            <span id="term-live-input"></span><span class="term-caret"></span>
        </div>
    </div>

<div id="bsod">
        <p style="background: white; color: blue; display: inline-block; padding: 2px;">FeistOS</p>
        <p>A fatal exception 0E has occurred at 0028:C0034B23 in VXD VMM(01) + 00013823. The current application will be terminated.</p>
        <p>* Press any key to terminate the current application.<br>
        * Press CTRL+ALT+DEL to restart your computer. You will lose any unsaved information in all applications.</p>
        <br>
        <p style="text-align: center; margin-top: 50px;">Press any key to continue_</p>
    </div>

    <div id="boot-screen">
        <div class="os-logo">Feist OS <span style="font-size: 1rem; opacity: 0.7;">v0.053</span></div>
        <div class="boot-log" id="boot-log"></div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <p style="margin-top: 15px; font-size: 0.8rem; opacity: 0.6;">Loading user data...</p>
    </div>

    <div id="desktop">
        <div id="selection-box"></div>
        <div id="start-menu">
            <div class="start-search-box" onclick="this.querySelector('input').focus()">
                <span>üîé</span> 
                <input type="text" id="start-input" placeholder="Type here to search..." 
                       onkeydown="if(event.key === 'Enter') handleStartSearch(this.value)"
                       style="background: transparent; border: none; color: white; width: 100%; outline: none; font-family: inherit;">
            </div>

            <div class="start-section-header">
                <div class="start-section-title">Pinned</div>
                <button class="start-section-btn" onclick="alert('System: All installed applications are already pinned.')">All apps ‚Ä∫</button>
            </div>
            
            <div class="start-pinned-grid">
                <div class="pinned-app" onclick="openWindow('browser', 'Quantum Browser'); toggleStartMenu();">
                    <div class="pinned-icon" style="background: linear-gradient(135deg, #3498db, #2980b9);">üåê</div>
                    <div class="pinned-name">Browser</div>
                </div>
                <div class="pinned-app" onclick="openWindow('explorer', '–≠—Ç–æ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä'); toggleStartMenu();">
                    <div class="pinned-icon" style="background: linear-gradient(135deg, #f1c40f, #d35400);">üíª</div>
                    <div class="pinned-name">Explorer</div>
                </div>
                <div class="pinned-app" onclick="openWindow('notepad', '–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞'); toggleStartMenu();">
                    <div class="pinned-icon" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">üìù</div>
                    <div class="pinned-name">Notepad</div>
                </div>
                <div class="pinned-app" onclick="openWindow('settings', '–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è'); toggleStartMenu();">
                    <div class="pinned-icon" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">‚öôÔ∏è</div>
                    <div class="pinned-name">Settings</div>
                </div>
                <div class="pinned-app" onclick="openWindow('wave_game', 'Neon Wave'); toggleStartMenu();">
                    <div class="pinned-icon" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">üéÆ</div>
                    <div class="pinned-name">Neon Wave</div>
                </div>
                <div class="pinned-app" onclick="triggerVirus(); toggleStartMenu();">
                    <div class="pinned-icon" style="background: #333; color: red;">‚ö†Ô∏è</div>
                    <div class="pinned-name">Do Not Click</div>
                </div>
            </div>

            <div class="start-section-header">
                <div class="start-section-title">Recommended</div>
                <button class="start-section-btn" onclick="alert('System: No more recent files found.')">More ‚Ä∫</button>
            </div>

            <div class="start-rec-list">
                <div class="rec-item" onclick="openWindow('notepad', '–í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏.txt'); toggleStartMenu();">
                    <div class="rec-icon" style="background: #eee; color: #333;">TXT</div>
                    <div class="rec-info">
                        <span class="rec-name">–í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏.txt</span>
                        <span class="rec-time">Recently added</span>
                    </div>
                </div>
                <div class="rec-item" onclick="openWindow('notepad', 'secret_pass.txt'); toggleStartMenu();">
                    <div class="rec-icon" style="background: #eee; color: #333;">TXT</div>
                    <div class="rec-info">
                        <span class="rec-name">secret_pass.txt</span>
                        <span class="rec-time">10 min ago</span>
                    </div>
                </div>
                <div class="rec-item">
                    <div class="rec-icon" style="background: #3498db; color: #fff;">IMG</div>
                    <div class="rec-info">
                        <span class="rec-name">feist_logo.png</span>
                        <span class="rec-time">2h ago</span>
                    </div>
                </div>
                <div class="rec-item">
                    <div class="rec-icon" style="background: #e74c3c; color: #fff;">PDF</div>
                    <div class="rec-info">
                        <span class="rec-name">Project_Titan.pdf</span>
                        <span class="rec-time">Yesterday</span>
                    </div>
                </div>
            </div>

            <div class="start-footer">
                <div class="user-profile" onclick="openWindow('settings', '–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è'); toggleStartMenu();">
                    <div class="user-avatar">U</div>
                    <div class="user-name">User Admin</div>
                </div>
                <button class="power-btn" onclick="location.reload()" title="Shut Down">‚èª</button>
            </div>
<div class="pinned-app" onclick="openWindow('spike_dodge', 'Spike Hell'); toggleStartMenu();">
                    <div class="pinned-icon" style="background: #ff0000; color: white;">‚ò†Ô∏è</div>
                    <div class="pinned-name">Spike Hell</div>
                </div>
        </div> <div class="taskbar">
            <button class="start-btn" id="start-btn" onclick="toggleStartMenu()">–ü–£–°–ö</button>
            <div id="taskbar-apps"></div>
            <button id="paint-btn" onclick="togglePaint()" style="margin-right: 10px; padding: 5px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 4px; cursor: pointer; font-size: 1.2rem;" title="Graffiti">üé®</button>
            <button id="gravity-btn" onclick="toggleGravity()" style="margin-right: 10px; padding: 5px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 4px; cursor: pointer; font-size: 1.2rem;" title="Physics">üßä</button>
            <div class="clock-container"><span id="clock">00:00</span></div>
        </div>
    </div> ```

<div id="virus-boot-screen" style="display: none;">
        <div class="virus-alert-box">
            <h1 class="virus-title">‚ö† SYSTEM BREACH DETECTED ‚ö†</h1>
            <div id="virus-console"></div>
            <div class="virus-progress">
                <div id="virus-bar"></div>
            </div>
        </div>
    </div>

    <script>

// ==========================================
        // –ó–ê–©–ò–¢–ê –û–¢ –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö–ê (NO CHEATS)
        // ==========================================
        document.addEventListener('contextmenu', event => event.preventDefault()); // –û—Ç–∫–ª—é—á–∞–µ—Ç –ø—Ä–∞–≤—É—é –∫–Ω–æ–ø–∫—É –º—ã—à–∏

        document.addEventListener('keydown', function(e) {
            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ F12
            if(e.keyCode == 123) {
                e.preventDefault();
                alert("NO.");
                return false;
            }
            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ Ctrl+Shift+I (DevTools)
            if (e.ctrlKey && e.shiftKey && (e.code === 'KeyI' || e.key === 'I' || e.key === 'i')) {
                e.preventDefault();
                return false;
            }
            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ Ctrl+U (–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–¥–∞)
            if(e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                return false;
            }
if (e.shiftKey && (e.key === '1' || e.code === 'Digit1')) {
        e.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
        openWindow('browser', 'Quantum Browser');
    }
        });

        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò–ö–û–ù–û–ö
        const defaultIcons = [
            { id: 'pc', label: '–≠—Ç–æ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä', type: 'sys', visualText: 'PC', app: 'explorer' },
{ id: 'virus', label: 'LOLOG Files', type: 'bin', visualText: 'RUN', app: 'virus_trap' },
            { id: 'notes', label: '–í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏.txt', type: 'doc', visualText: 'TXT', app: 'notepad' },
            { id: 'browser', label: 'Quantum Browser', type: 'app', visualText: 'WEB', app: 'browser' },
            { id: 'settings', label: '–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è', type: 'set', visualText: 'CFG', app: 'settings' },
            { id: 'trash', label: '–ö–æ—Ä–∑–∏–Ω–∞', type: 'bin', visualText: 'BIN', app: 'trash' },
{ id: 'race', label: 'Cyber Bet', type: 'app', visualText: 'RACE', app: 'cyber_bet' },
{ id: 'wave', label: 'Neon Wave', type: 'app', visualText: 'WAVE', app: 'wave_game' },
{ id: 'spike', label: 'Spike Hell', type: 'app', visualText: 'DIE', app: 'spike_dodge' },
        ];

        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        const desktop = document.getElementById('desktop');
        const selectionBox = document.getElementById('selection-box');
        const startMenu = document.getElementById('start-menu');
        const startBtn = document.getElementById('start-btn');
        let zIndexCounter = 100; 
let isSpacePressed = false;
        window.addEventListener('keydown', (e) => { if(e.code === 'Space') isSpacePressed = true; });
        window.addEventListener('keyup', (e) => { if(e.code === 'Space') isSpacePressed = false; });
        let selectedIcons = new Set();


// --- –§–ê–ô–õ–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê ---
        const sysFiles = {
            "root": {
                name: "C:",
                type: "folder",
                children: {
                    "FeistOS": { 
                        type: "folder",
                        children: {
                            "System": { 
                                type: "folder",
                                children: {
                                    "kernel.sys": { type: "file", icon: "SYS", critical: "bsod" },
                                    "gui_render.exe": { type: "file", icon: "EXE", critical: "no_desktop" },
                                    "boot.bin": { type: "file", icon: "BIN", critical: "reboot_loop" }
                                }
                            },
                            "Visuals": {
                                type: "folder",
                                children: {
                                    "theme.css": { type: "file", icon: "CSS", critical: "ugly_mode" },
                                    "icons.dat": { type: "file", icon: "DAT", critical: "no_icons" }
                                }
                            }
                        }
                    },
                    "Home": { 
                        type: "folder",
                        children: {
                            "Admin": {
                                type: "folder",
                                children: {
                                    "Documents": {
                                        type: "folder",
                                        children: {
                                            "secret_pass.txt": { type: "file", icon: "TXT", content: "OVERRIDE CODE: =)" },
                                            "dev_log.txt": { type: "file", icon: "TXT", content: "To-do: Fix the audio bug in kernel." }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        };
        let currentPath = [];

        // ==========================================
        // 1. –ó–ê–ì–†–£–ó–ö–ê (BOOT LOGIC)
        // ==========================================
        const bootScreen = document.getElementById('boot-screen');
        const progressBar = document.getElementById('progress-bar');
        const bootLog = document.getElementById('boot-log');
        const logMessages = [
            "Initializing FeistOS Kernel v0.053...",
            "Loading drivers [VESA, AUDIO, NET]...",
            "Mounting file system...",
            "Reading LocalStorage data...",
            "Starting Graphical User Interface...",
            "Welcome to FeistOS."
        ];
        let logIndex = 0;
        let progress = 0;

        function simulateBoot() {
            // --- –ü–†–û–í–ï–†–ö–ê –ù–ê –í–ò–†–£–° + –ë–≠–ö–î–û–† (BACKDOOR) ---
            if (localStorage.getItem('feistos_infected') === 'true') {
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ —á–µ—Ä–µ–∑ ESC
                document.addEventListener('keydown', checkBiosInterrupt);
                triggerVirus(true); 
                return;
            }
            // ----------------------------------------------------------

            const interval = setInterval(() => {
                progress += Math.random() * 4;
                if (progress > 100) progress = 100;
                progressBar.style.width = progress + '%';

                if (progress > (logIndex * 20) && logIndex < logMessages.length) {
                    const p = document.createElement('div');
                    p.textContent = `[ OK ] ${logMessages[logIndex]}`;
                    bootLog.appendChild(p);
                    bootLog.scrollTop = bootLog.scrollHeight;
                    logIndex++;
                }

                if (progress === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        bootScreen.style.opacity = '0';
                        setTimeout(() => {
                            bootScreen.style.display = 'none';
                            desktop.style.display = 'block';
                            initDesktop();
                            startClock();
loadUserSettings();
                        }, 800);
                    }, 500);
                }
            }, 60);
        }

        function startClock() {
            setInterval(() => {
                document.getElementById('clock').textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            }, 1000);
        }

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ FeistOS
function loadUrl(btn, winId) {
    const input = document.getElementById(`url-${winId}`);
    const iframe = document.getElementById(`frame-${winId}`);
    let url = input.value.trim();

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º https://, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±—ã–ª
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –≤–≤–µ–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–ª–æ–≤–æ –±–µ–∑ —Ç–æ—á–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä "–∫–æ—Ç–∏–∫–∏"), –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Bing
        if (!url.includes('.')) {
            url = "https://www.bing.com/search?q=" + encodeURIComponent(url);
        } else {
            url = 'https://' + url;
        }
    }

    // --- 1. YOUTUBE ---
    // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º youtube.com/watch?v=ID –∏–ª–∏ youtu.be/ID –≤ youtube.com/embed/ID
    if (url.includes('youtube.com/watch') || url.includes('youtu.be/')) {
        let videoId = "";
        if (url.includes('youtu.be/')) {
            videoId = url.split('youtu.be/')[1].split('?')[0];
        } else {
            try {
                videoId = new URL(url).searchParams.get('v');
            } catch(e) {}
        }
        
        if (videoId) {
            url = `https://www.youtube-nocookie.com/embed/${videoId}`;
        }
    } 
    
    // --- 2. TWITCH ---
    // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º twitch.tv/username –≤ player.twitch.tv
    else if (url.includes('twitch.tv/')) {
        // –î–æ—Å—Ç–∞–µ–º –∏–º—è —Å—Ç—Ä–∏–º–µ—Ä–∞ –∏–∑ —Å—Å—ã–ª–∫–∏
        const channel = url.split('twitch.tv/')[1].split('/')[0].split('?')[0];
        
        // –í–ê–ñ–ù–û: Twitch —Ç—Ä–µ–±—É–µ—Ç —É–∫–∞–∑–∞—Ç—å –¥–æ–º–µ–Ω, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–ø—É—â–µ–Ω iframe (parent)
        // –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—à—å –ø—Ä–æ—Å—Ç–æ —Ñ–∞–π–ª–æ–º (file://), —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç, –Ω—É–∂–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
        const currentHost = window.location.hostname || "localhost";
        
        if (channel) {
            url = `https://player.twitch.tv/?channel=${channel}&parent=${currentHost}`;
        }
    }

    // --- 3. RUTUBE (–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ) ---
    else if (url.includes('rutube.ru/video/')) {
        const videoId = url.split('rutube.ru/video/')[1].replace('/', '');
        if (videoId) {
            url = `https://rutube.ru/play/embed/${videoId}`;
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ–∏—Å–∫–∞ –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º iframe
    input.value = url;
    iframe.src = url;
}

// –¢–∞–∫–∂–µ –Ω—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –Ω–∞–∂–∞—Ç–∏–µ Enter –≤ –∏–Ω–ø—É—Ç–µ –±—Ä–∞—É–∑–µ—Ä–∞
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.target.id.startsWith('url-')) {
        const winId = e.target.id.split('-')[1];
        const btn = e.target.nextElementSibling;
        loadUrl(btn, winId);
    }
});

        // ==========================================
        // 2. –ú–ï–ù–Æ –ü–£–°–ö (–õ–û–ì–ò–ö–ê)
        // ==========================================
        function toggleStartMenu() {
            if (startMenu.style.display === 'flex') {
                startMenu.style.display = 'none';
                startBtn.classList.remove('active');
            } else {
                startMenu.style.display = 'flex';
                startBtn.classList.add('active');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—É—Å–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('mousedown', function(e) {
            if (!startMenu.contains(e.target) && !startBtn.contains(e.target)) {
                startMenu.style.display = 'none';
                startBtn.classList.remove('active');
            }
        });

// –§–£–ù–ö–¶–ò–Ø –ü–û–ò–°–ö–ê –í –ü–£–°–ö–ï
        function handleStartSearch(query) {
            if(!query.trim()) return;
            
            toggleStartMenu();
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä –∏ –≥—É–≥–ª–∏–º –∑–∞–ø—Ä–æ—Å
            openWindow('browser', 'Quantum Browser');
            
            // –ñ–¥–µ–º –ø–æ–∫–∞ –æ–∫–Ω–æ —Å–æ–∑–¥–∞—Å—Ç—Å—è –∏ –º–µ–Ω—è–µ–º URL (–Ω–µ–±–æ–ª—å—à–æ–π –∫–æ—Å—Ç—ã–ª—å, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)
            setTimeout(() => {
                const input = document.getElementById(`url-${zIndexCounter}`);
                const iframe = document.getElementById(`frame-${zIndexCounter}`);
                if(input && iframe) {
                    const searchUrl = "https://www.bing.com/search?q=" + encodeURIComponent(query);
                    input.value = searchUrl;
                    iframe.src = searchUrl;
                }
            }, 100);
        }

        // ==========================================
        // 3. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ö–û–ù–û–ö
        // ==========================================
        function initDesktop() {
            let col = 0, row = 0;
            const startX = 20, startY = 20;
            const gridX = 100, gridY = 110;
            const maxRows = Math.floor((window.innerHeight - 60) / gridY);

            defaultIcons.forEach(data => {
                const icon = document.createElement('div');
                icon.className = 'icon';
                icon.innerHTML = `
                    <div class="icon-visual ${data.type}">${data.visualText}</div>
                    <span>${data.label}</span>
                `;
                
                icon.style.left = (startX + col * gridX) + 'px';
                icon.style.top = (startY + row * gridY) + 'px';
                
                icon.addEventListener('mousedown', (e) => onIconMouseDown(e, icon));
                icon.addEventListener('dblclick', () => openWindow(data.app, data.label));

                desktop.appendChild(icon);

                row++;
                if (row >= maxRows) { row = 0; col++; }
            });

            desktop.addEventListener('mousedown', onDesktopMouseDown);
        }

       // ==========================================
        // 4. –ú–ï–ù–ï–î–ñ–ï–† –û–ö–û–ù (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô)
        // ==========================================
        function openWindow(appType, title) {
            // --- –ü–†–û–í–ï–†–ö–ê –ù–ê –í–ò–†–£–° ---
            if (appType === 'virus_trap') {
                triggerVirus();
                return; 
            }
            
            const winId = 'win-' + (++zIndexCounter);
            const win = document.createElement('div');
            win.className = 'window';
            win.id = winId;
            win.style.left = '100px'; win.style.top = '50px';
            win.style.width = '500px'; win.style.height = '400px';
            win.style.zIndex = zIndexCounter;

            let contentHtml = '';

            // --- –ö–û–ù–¢–ï–ù–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–ô ---
            if (appType === 'notepad') {
                const savedText = localStorage.getItem('feistos_notepad_data') || "–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–≤–æ–∏ –∑–∞–º–µ—Ç–∫–∏...";
                contentHtml = `<textarea id="notepad-area" style="width:100%; height:100%; border:none; padding:10px; resize:none; outline:none; font-family: monospace; box-sizing: border-box; background: transparent;">${savedText}</textarea>`;
            } 
else if (appType === 'cyber_bet') {
    const money = localStorage.getItem('feistos_money') || "1000";
    
    contentHtml = `
        <div id="race-root-${zIndexCounter}" style="position:relative; width:100%; height:100%; background:#111; overflow:hidden; display:flex; flex-direction:column;">
            
            <div id="bet-screen-${zIndexCounter}" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:10; background:rgba(0,0,0,0.95); display:flex; flex-direction:column; align-items:center; justify-content:center;">
                <h1 style="color:#00ffff; font-family:'Segoe UI'; text-transform:uppercase; margin-bottom:5px; text-shadow:0 0 10px #00ffff;">STREET RACING</h1>
                <h3 style="color:#fff; font-family:'Segoe UI'; font-weight:normal; margin-bottom:20px;">SELECT YOUR VEHICLE</h3>
                
                <div style="color:#fff; margin-bottom:15px;">BALANCE: <span style="color:#00ff00;">$${money}</span></div>
                
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-bottom:20px; width: 90%;">
                    <button onclick="startPlayerRace(${zIndexCounter}, 0)" style="padding:15px; border:2px solid #ff0055; background:#330011; color:#ff0055; cursor:pointer;"><b>RED DEVIL</b><br><small>Balanced</small></button>
                    <button onclick="startPlayerRace(${zIndexCounter}, 1)" style="padding:15px; border:2px solid #33ff33; background:#002200; color:#33ff33; cursor:pointer;"><b>VIPER</b><br><small>Grip</small></button>
                    <button onclick="startPlayerRace(${zIndexCounter}, 2)" style="padding:15px; border:2px solid #00ccff; background:#001133; color:#00ccff; cursor:pointer;"><b>GHOST</b><br><small>Speed</small></button>
                    <button onclick="startPlayerRace(${zIndexCounter}, 3)" style="padding:15px; border:2px solid #ffff00; background:#333300; color:#ffff00; cursor:pointer;"><b>TANK</b><br><small>Heavy</small></button>
                    
                    <button onclick="startPlayerRace(${zIndexCounter}, 4)" style="padding:15px; border:2px solid #9b59b6; background:#2c0033; color:#9b59b6; cursor:pointer;"><b>DRIFT</b><br><small>Slidy</small></button>
                    <button onclick="startPlayerRace(${zIndexCounter}, 5)" style="padding:15px; border:2px solid #e67e22; background:#331a00; color:#e67e22; cursor:pointer;"><b>MAD</b><br><small>Aggro</small></button>
                    <button onclick="startPlayerRace(${zIndexCounter}, 6)" style="padding:15px; border:2px solid #ecf0f1; background:#333; color:#fff; cursor:pointer;"><b>POLICE</b><br><small>Fast</small></button>
                    <button onclick="startPlayerRace(${zIndexCounter}, 7)" style="padding:15px; border:2px solid #ff00ff; background:#330033; color:#ff00ff; cursor:pointer;"><b>NEON</b><br><small>Turbo</small></button>
                </div>
                <div style="color:#aaa; font-size:0.9em;">Entry Fee: <span style="color:#ff5555">-$100</span> | Prize: <span style="color:#00ff00">+$1000</span></div>
                <div style="color:#888; font-size:0.8em; margin-top:10px;">CONTROLS: WASD or ARROWS</div>
            </div>

            <canvas id="race-canvas-${zIndexCounter}" style="flex:1; display:block;"></canvas>
            
            <div id="race-ui-${zIndexCounter}" style="position:absolute; top:10px; left:10px; pointer-events:none; display:none;">
                <div style="background:rgba(0,0,0,0.6); padding:10px; border-left: 3px solid #00ffff; color:#fff; font-family:monospace;">
                    <div style="font-size:1.2em; font-weight:bold;">LAP <span id="lap-counter-${zIndexCounter}">1/2</span></div>
                    <div style="font-size:1.5em; color:#00ffff;" id="speed-meter-${zIndexCounter}">0 KM/H</div>
                    <div id="pos-meter-${zIndexCounter}" style="color:#ff0055; font-weight:bold;">POS: 8/8</div>
                </div>
                <div id="bet-status-${zIndexCounter}" style="margin-top:5px; font-size:2em; font-weight:bold; text-shadow: 2px 2px 0 #000;"></div>
            </div>
        </div>
    `;
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    setTimeout(() => {
        const w = document.getElementById(winId);
        if(w) { w.style.width = '1000px'; w.style.height = '700px'; }
    }, 10);
}
            else if (appType === 'browser') {
                let contentBody = '';
                let urlValue = 'https://ru.m.wikipedia.org';

                // --- –õ–û–ì–ò–ö–ê –ó–ê–†–ê–ñ–ï–ù–ò–Ø ---
                if (localStorage.getItem('feistos_infected') === 'true') {
                    urlValue = 'http://lllolll.lllol/hidden_data';
                    
                    const secretPass = "PASSWORD: DANIELSAPOG";
                    
                    // 1. –ü–ï–†–ï–ú–ï–®–ò–í–ê–ï–ú –ë–£–ö–í–´
                    let scrambledChars = secretPass.split('').sort(() => Math.random() - 0.5);

                    // –ù–∞–±–æ—Ä —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –º—É—Å–æ—Ä–∞
                    const junkChars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz!@#$%^&*()_+-=[]{}|;:,./?";
                    let massiveText = "";
                    
                    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
                    for (let char of scrambledChars) {
                        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º—É—Å–æ—Ä
                        const noiseLength = Math.floor(Math.random() * 300) + 400;
                        
                        for (let i = 0; i < noiseLength; i++) {
                            massiveText += junkChars.charAt(Math.floor(Math.random() * junkChars.length));
                            if (Math.random() > 0.98) massiveText += " "; 
                        }
                        
                        // 2. –í–°–¢–ê–í–õ–Ø–ï–ú –ë–£–ö–í–£ (–ü–û–õ–ù–´–ô –°–¢–ï–õ–°)
                        // –¶–≤–µ—Ç –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è (#333), –∂–∏—Ä–Ω–æ—Å—Ç–∏ –Ω–µ—Ç.
                        // –ï–î–ò–ù–°–¢–í–ï–ù–ù–û–ï –æ—Ç–ª–∏—á–∏–µ ‚Äî –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ.
                        massiveText += `<span style="text-decoration: underline;">${char}</span>`;
                    }

                    // –•–≤–æ—Å—Ç –º—É—Å–æ—Ä–∞
                    for (let i = 0; i < 600; i++) {
                         massiveText += junkChars.charAt(Math.floor(Math.random() * junkChars.length));
                         if (Math.random() > 0.95) massiveText += " "; 
                    }

                    contentBody = `
                        <div style="background-color: #000; color: #333; font-family: 'Courier New', monospace; 
                                    padding: 20px; height: 100%; overflow-y: auto; word-break: break-all; font-size: 14px; line-height: 1.5;">
                            <h1 style="color: #444; text-align: center; font-size:1.5rem; margin-bottom:10px;">KERNEL MEMORY DUMP</h1>
                            <p style="text-align: center; color: #444; margin-bottom: 30px; font-size: 0.9rem;">SEARCHING FOR PATTERNS...</p>
                            <hr style="border-color: #222; margin-bottom: 20px;">
                            ${massiveText}
                        </div>
                    `;
                } else {
                    // –û–ë–´–ß–ù–´–ô –†–ï–ñ–ò–ú
                    contentBody = `<iframe id="frame-${zIndexCounter}" src="https://ru.m.wikipedia.org" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                }

                contentHtml = `
                    <div class="browser-bar">
    <input type="text" id="url-${zIndexCounter}" value="${urlValue}">
    <button onclick="loadUrl(this, ${zIndexCounter})">Go</button>
</div>
                    ${contentBody}
                `;
            }
else if (appType === 'wave_game') {
                // –ü–æ–ª—É—á–∞–µ–º –ª—É—á—à–∏–π —Ä–µ–∫–æ—Ä–¥
                const bestScore = localStorage.getItem('feistos_wave_best') || 0;
                
                contentHtml = `
                    <div style="position: relative; width: 100%; height: 100%; background: #000; overflow: hidden;">
                        <canvas id="waveCanvas-${zIndexCounter}" style="display: block; width: 100%; height: 100%;"></canvas>
                        
                        <div id="wave-ui-${zIndexCounter}" style="position: absolute; top: 10px; left: 10px; pointer-events: none; font-family: 'Courier New', monospace; font-weight: bold;">
                            <div style="color: #00ff00; font-size: 20px;">TIME: <span id="score-now-${zIndexCounter}">0.00</span>s</div>
                            <div style="color: #0088ff; font-size: 14px;">BEST: <span id="score-best-${zIndexCounter}">${parseFloat(bestScore).toFixed(2)}</span>s</div>
                        </div>

                        <div id="wave-menu-${zIndexCounter}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                                    background: rgba(0,0,0,0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10;">
                            <h1 style="color: #33ff33; font-family: 'Segoe UI', sans-serif; text-transform: uppercase; text-shadow: 0 0 10px #33ff33;">Neon Wave</h1>
                            <p style="color: #fff; margin-bottom: 20px;">HOLD CLICK to go UP / RELEASE to go DOWN</p>
                            <button onclick="initWaveGame(${zIndexCounter})" style="padding: 10px 30px; background: #33ff33; border: none; font-weight: bold; cursor: pointer; font-family: inherit;">START GAME</button>
                        </div>
                    </div>
                `;
            }
            else if (appType === 'trash') {
                contentHtml = `<div style="padding:20px; text-align:center;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</div>`;
            }
else if (appType === 'settings') {
                // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–º—è –∏–ª–∏ —Å—Ç–∞–≤–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ
                const savedName = localStorage.getItem('feistos_username') || "User Admin";
                
                contentHtml = `
                    <div class="settings-layout">
                        <div class="settings-sidebar">
                            <div class="settings-tab-btn active" onclick="switchTab('${winId}', 'sys')">–°–∏—Å—Ç–µ–º–∞</div>
                            <div class="settings-tab-btn" onclick="switchTab('${winId}', 'pers')">–í–∏–¥</div>
                            <div class="settings-tab-btn" onclick="switchTab('${winId}', 'user')">–ê–∫–∫–∞—É–Ω—Ç</div>
                            <div class="settings-tab-btn" onclick="switchTab('${winId}', 'sec')">–°–±—Ä–æ—Å</div>
                        </div>
                        <div class="settings-content-area">
                            <div id="tab-${winId}-sys" class="settings-section active">
                                <h2>–û —Å–∏—Å—Ç–µ–º–µ</h2>
                                <div class="setting-group">
                                    <div class="setting-label">–í–µ—Ä—Å–∏—è FeistOS</div>
                                    <div style="font-family:monospace; color:#333;">v0.053 Alpha</div>
                                </div>
                                <div class="setting-group">
                                    <div class="setting-label">–°—Ç–∞—Ç—É—Å —è–¥—Ä–∞</div>
                                    <div style="color:green;">‚óè ONLINE</div>
                                </div>
                                <div class="setting-group">
                                    <div class="setting-label">–ò–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</div>
                                    <input type="text" class="st-input" value="WORKSTATION-X" disabled style="background:#eee;">
                                </div>
                            </div>

                            <div id="tab-${winId}-pers" class="settings-section">
                                <h2>–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</h2>
                                <div class="setting-group">
                                    <div class="setting-label">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç (Neon Color)</div>
                                    <div class="color-picker-btn" style="background:#33ff33;" onclick="changeSystemColor('#33ff33')"></div>
                                    <div class="color-picker-btn" style="background:#00ccff;" onclick="changeSystemColor('#00ccff')"></div>
                                    <div class="color-picker-btn" style="background:#ff0055;" onclick="changeSystemColor('#ff0055')"></div>
                                    <div class="color-picker-btn" style="background:#ffff00;" onclick="changeSystemColor('#ffff00')"></div>
                                    <div class="color-picker-btn" style="background:#bdc3c7;" onclick="changeSystemColor('#bdc3c7')"></div>
                                </div>
                                <div class="setting-group">
                                    <div class="setting-label">–§–æ–Ω —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞</div>
                                    <div class="bg-picker-item" style="background:radial-gradient(circle, #2b4162, #12100e);" 
                                         onclick="changeWallpaper('radial-gradient(circle at center, #2b4162 0%, #12100e 100%)')"></div>
                                    <div class="bg-picker-item" style="background:linear-gradient(45deg, #2c3e50, #4ca1af);" 
                                         onclick="changeWallpaper('linear-gradient(45deg, #2c3e50, #4ca1af)')"></div>
                                    <div class="bg-picker-item" style="background:#000;" 
                                         onclick="changeWallpaper('#000')"></div>
                                </div>
                            </div>

                            <div id="tab-${winId}-user" class="settings-section">
                                <h2>–£—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å</h2>
                                <div class="setting-group">
                                    <div class="setting-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                                    <input type="text" class="st-input" id="username-input-${winId}" value="${savedName}" oninput="changeUsername(this.value)">
                                </div>
                                <div class="setting-group">
                                    <div class="setting-label">–ê–≤–∞—Ç–∞—Ä</div>
                                    <div class="user-avatar" style="width:50px; height:50px; font-size:1.5rem; margin:0 auto;">${savedName.charAt(0).toUpperCase()}</div>
                                </div>
                            </div>
                            
                            <div id="tab-${winId}-sec" class="settings-section">
                                <h2 style="color:red;">–û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h2>
                                <div class="setting-group" style="border-color:red;">
                                    <div class="setting-label">–ó–∞–≤–æ–¥—Å–∫–æ–π —Å–±—Ä–æ—Å</div>
                                    <p style="font-size:11px; margin-bottom:10px;">–≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –≤–∫–ª—é—á–∞—è –≤–∏—Ä—É—Å—ã, —Ñ–∞–π–ª—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</p>
                                    <button class="danger-btn" onclick="factoryReset()">–§–û–†–ú–ê–¢–ò–†–û–í–ê–¢–¨ –î–ò–°–ö C:</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            else if (appType === 'explorer') {
                contentHtml = `
                    <div style="padding:5px; background:#ddd; border-bottom:1px solid #999; display:flex; gap:10px; align-items:center;">
                        <span class="path-display" style="font-family:monospace; flex:1;">C:/</span>
                    </div>
                    <div class="file-list" id="explorer-files-${winId}" style="padding:10px; display:flex; flex-wrap:wrap; gap:10px; align-content: flex-start;">
                        </div>
                `;
                
                setTimeout(() => {
                    currentPath = []; 
                    renderExplorerContent('explorer-files-' + winId);
                }, 10);
}
            else if (appType === 'spike_dodge') {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏–ª–∏ —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
                const savedPlayerColor = localStorage.getItem('feistos_spike_p_color') || '#ffffff';
                const savedSpikeColor = localStorage.getItem('feistos_spike_s_color') || '#ff0000';

                contentHtml = `
                    <div style="position: relative; width: 100%; height: 100%; background: #111; overflow: hidden; cursor: default;">
                        <canvas id="spikeCanvas-${zIndexCounter}" style="display: block; width: 100%; height: 100%;"></canvas>
                        
                        <div id="spike-ui-${zIndexCounter}" style="position: absolute; top: 10px; left: 10px; pointer-events: none; font-family: 'Courier New', monospace; font-weight: bold; z-index: 2; display: none;">
                            <div style="color: #fff; font-size: 24px;">TIME: <span id="spike-timer-${zIndexCounter}" style="color: #ff0055;">0.00</span>s <span id="spike-mode-label-${zIndexCounter}" style="font-size: 0.6em; opacity: 0.7;"></span></div>
                        </div>

                        <div id="spike-menu-${zIndexCounter}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                                    background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10;">
                            
                            <h1 style="color: #ff0055; font-family: 'Impact', sans-serif; font-size: 4rem; margin: 0; letter-spacing: 5px; text-shadow: 0 0 20px red;">SPIKE HELL</h1>
                            <p style="color: #ccc; margin-bottom: 30px; font-size: 1.2rem;">DODGE EVERYTHING.</p>
                            
                            <div id="menu-buttons-${zIndexCounter}" style="display: flex; flex-direction: column; gap: 15px; width: 250px;">
                                <button onclick="window.startSpikeGame(${zIndexCounter}, 'survival')" style="padding: 15px; background: #ff0055; color: white; border: none; font-weight: bold; cursor: pointer; font-size: 1.2rem; box-shadow: 0 0 10px #ff0055;">SURVIVAL (60s)</button>
                                <button onclick="window.startSpikeGame(${zIndexCounter}, 'infinity')" style="padding: 15px; background: #9b59b6; color: white; border: none; font-weight: bold; cursor: pointer; font-size: 1.2rem; box-shadow: 0 0 10px #8e44ad;">INFINITY ‚àû</button>
                                <button onclick="document.getElementById('settings-panel-${zIndexCounter}').style.display='flex'; document.getElementById('menu-buttons-${zIndexCounter}').style.display='none';" style="padding: 10px; background: #333; color: white; border: 1px solid #555; cursor: pointer;">SETTINGS</button>
                            </div>

                            <div id="settings-panel-${zIndexCounter}" style="display: none; flex-direction: column; gap: 15px; background: #222; padding: 20px; border: 1px solid #444; width: 300px;">
                                <h3 style="color: white; margin: 0; text-align: center;">CONFIGURATION</h3>
                                <hr style="width: 100%; border: 0; border-top: 1px solid #444;">
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; color: white;">
                                    <span>Player Color:</span>
                                    <input type="color" id="p-color-${zIndexCounter}" value="${savedPlayerColor}" style="cursor: pointer;">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; color: white;">
                                    <span>Spike Color:</span>
                                    <input type="color" id="s-color-${zIndexCounter}" value="${savedSpikeColor}" style="cursor: pointer;">
                                </div>

                                <hr style="width: 100%; border: 0; border-top: 1px solid #444;">
                                <button onclick="document.getElementById('settings-panel-${zIndexCounter}').style.display='none'; document.getElementById('menu-buttons-${zIndexCounter}').style.display='flex';" style="padding: 10px; background: #444; color: white; border: none; cursor: pointer;">BACK</button>
                            </div>

                            <div id="game-over-content-${zIndexCounter}"></div>
                        </div>
                    </div>
                `;
            } else {
                contentHtml = `<div style="display:flex; justify-content:center; align-items:center; height:100%;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
            }

            win.innerHTML = `
                <div class="window-header">
                    <div class="window-title">${title}</div>
                    <div class="window-controls">
                        <button class="btn-minimize">‚Äì</button>
                        <button class="btn-close">√ó</button>
                    </div>
                </div>
                <div class="window-content" style="display:flex; flex-direction:column;">${contentHtml}</div>
            `;

            desktop.appendChild(win);

            // –ü–∞–Ω–µ–ª—å –∑–∞–¥–∞—á –∏ —Å–æ–±—ã—Ç–∏—è
            const taskbarContainer = document.getElementById('taskbar-apps');
            const taskBtn = document.createElement('div');
            taskBtn.className = 'taskbar-app active';
            taskBtn.textContent = title;
            taskbarContainer.appendChild(taskBtn);

            // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫
            const toggleWin = () => {
                if(win.style.display === 'none') { win.style.display = 'flex'; win.style.zIndex = ++zIndexCounter; taskBtn.classList.add('active'); }
                else { win.style.display = 'none'; taskBtn.classList.remove('active'); }
            };
            taskBtn.onclick = toggleWin;
            win.querySelector('.btn-minimize').onclick = () => { win.style.display = 'none'; taskBtn.classList.remove('active'); };
            win.querySelector('.btn-close').onclick = () => { win.remove(); taskBtn.remove(); };

            if (appType === 'notepad') {
                win.querySelector('#notepad-area').addEventListener('input', function() { localStorage.setItem('feistos_notepad_data', this.value); });
            }

            makeDraggable(win, win.querySelector('.window-header'));
            win.addEventListener('mousedown', () => { win.style.zIndex = ++zIndexCounter; });

// --- –î–û–ë–ê–í–ö–ê –î–õ–Ø –ì–†–ê–í–ò–¢–ê–¶–ò–ò ---
            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω, –Ω–æ–≤–æ–µ –æ–∫–Ω–æ —Å—Ä–∞–∑—É –ø–∞–¥–∞–µ—Ç
            if (typeof gravityActive !== 'undefined' && gravityActive) {
                // –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –º–≥–Ω–æ–≤–µ–Ω–∏–µ –Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã
                setTimeout(() => {
                    const rect = win.getBoundingClientRect();
                    
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤ —Ä–µ–∂–∏–º —Ñ–∏–∑–∏–∫–∏ (–≤—ã—Ä—ã–≤–∞–µ–º –∏–∑ –≤–µ—Ä—Å—Ç–∫–∏)
                    win.style.position = 'fixed';
                    win.style.left = rect.left + 'px';
                    win.style.top = rect.top + 'px';
                    win.style.margin = '0';
                    win.style.zIndex = '9999';

                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–∏—Å—Ç–µ–º—É
                    physicsObjects.push({
                        el: win,
                        x: rect.left,
                        y: rect.top,
                        w: rect.width,
                        h: rect.height,
                        vx: 0, 
                        vy: 5, // –ù–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤–Ω–∏–∑
                        isDragging: false
                    });
                    
                    win.onmousedown = (e) => startPhysDrag(e, win);
                }, 50);
            }
        }

        // ==========================================
        // 5. DRAG & DROP –ò –í–´–î–ï–õ–ï–ù–ò–ï
        // ==========================================
        
        function makeDraggable(el, handle) {
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const shiftX = e.clientX - el.getBoundingClientRect().left;
                const shiftY = e.clientY - el.getBoundingClientRect().top;
                
                function moveAt(pageX, pageY) {
                    el.style.left = pageX - shiftX + 'px';
                    el.style.top = pageY - shiftY + 'px';
                }
                function onMouseMove(e) { moveAt(e.pageX, e.pageY); }
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', () => document.removeEventListener('mousemove', onMouseMove), {once:true});
            });
        }

        function onIconMouseDown(e, icon) {
            e.stopPropagation();
            if (e.ctrlKey) {
if (paintActive && !isSpacePressed) return;
e.stopPropagation();
                if (selectedIcons.has(icon)) deselectIcon(icon);
                else selectIcon(icon);
            } else {
                if (!selectedIcons.has(icon)) {
                    clearSelection();
                    selectIcon(icon);
                }
            }
            startIconDrag(e);
        }

        function startIconDrag(e) {
            e.preventDefault();
            const startMouseX = e.clientX, startMouseY = e.clientY;
            const initialPositions = new Map();
            selectedIcons.forEach(icon => {
                initialPositions.set(icon, { left: parseInt(icon.style.left), top: parseInt(icon.style.top) });
            });

            function onMouseMove(moveEvent) {
                const dx = moveEvent.clientX - startMouseX;
                const dy = moveEvent.clientY - startMouseY;
                selectedIcons.forEach(icon => {
                    const pos = initialPositions.get(icon);
                    icon.style.left = (pos.left + dx) + 'px';
                    icon.style.top = (pos.top + dy) + 'px';
                });
            }
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', () => document.removeEventListener('mousemove', onMouseMove), {once:true});
        }

        function onDesktopMouseDown(e) {
            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ –º–µ–Ω—é –ø—É—Å–∫ –∏–ª–∏ –∫–Ω–æ–ø–∫–µ –ø—É—Å–∫ - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º —Ç—É—Ç
            if (e.target.closest('#start-menu') || e.target.closest('#start-btn')) return;
if (paintActive && !isSpacePressed) return;

            if (e.target !== desktop) return;
            if (!e.ctrlKey) clearSelection();
            
            const startX = e.clientX, startY = e.clientY;
            selectionBox.style.display = 'block';
            selectionBox.style.width = '0px'; selectionBox.style.height = '0px';
            selectionBox.style.left = startX + 'px'; selectionBox.style.top = startY + 'px';

            function onMouseMove(ev) {
                const currentX = ev.clientX, currentY = ev.clientY;
                const width = Math.abs(currentX - startX), height = Math.abs(currentY - startY);
                const left = Math.min(currentX, startX), top = Math.min(currentY, startY);

                selectionBox.style.left = left + 'px'; selectionBox.style.top = top + 'px';
                selectionBox.style.width = width + 'px'; selectionBox.style.height = height + 'px';

                checkSelectionCollision(selectionBox.getBoundingClientRect());
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', () => {
                selectionBox.style.display = 'none';
                document.removeEventListener('mousemove', onMouseMove);
            }, {once:true});
        }

        function checkSelectionCollision(box) {
            document.querySelectorAll('.icon').forEach(icon => {
                const r = icon.getBoundingClientRect();
                if (!(box.right < r.left || box.left > r.right || box.bottom < r.top || box.top > r.bottom)) {
                    selectIcon(icon);
                }
            });
        }

        function selectIcon(icon) { selectedIcons.add(icon); icon.classList.add('selected'); }
        function deselectIcon(icon) { selectedIcons.delete(icon); icon.classList.remove('selected'); }
        function clearSelection() { selectedIcons.forEach(icon => icon.classList.remove('selected')); selectedIcons.clear(); }

        window.onload = simulateBoot;

// ==========================================
        // –ó–ê–ü–£–°–ö –í–ò–†–£–°–ê (BSOD -> RED SCREEN -> DESKTOP)
        // ==========================================
        function triggerVirus(fastStart = false) {
            paintActive = false;
            const pCanvas = document.getElementById('graffiti-layer');
            if(pCanvas) pCanvas.getContext('2d').clearRect(0, 0, pCanvas.width, pCanvas.height);
            
            localStorage.setItem('feistos_infected', 'true');
            
            // –í–∫–ª—é—á–∞–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç BIOS (F1)
            document.addEventListener('keydown', checkBiosInterrupt);

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë –ª–∏—à–Ω–µ–µ
            document.getElementById('desktop').style.display = 'none';
            document.getElementById('boot-screen').style.display = 'none'; 

            // –§–£–ù–ö–¶–ò–Ø –ó–ê–ü–£–°–ö–ê –ö–†–ê–°–ù–û–ì–û –≠–ö–†–ê–ù–ê (–í–ù–£–¢–†–ï–ù–ù–Ø–Ø)
            const startRedScreen = () => {
                // –°–∫—Ä—ã–≤–∞–µ–º BSOD (–µ—Å–ª–∏ –±—ã–ª)
                document.getElementById('bsod').style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–Ω—ã–π —ç–∫—Ä–∞–Ω
                const vScreen = document.getElementById('virus-boot-screen');
                vScreen.style.display = 'flex';
                
                const vConsole = document.getElementById('virus-console');
                const vBar = document.getElementById('virus-bar');
                vConsole.innerHTML = ''; 
                vBar.style.width = '0%';

                const virusLogs = [
                    "INITIATING OVERRIDE SEQUENCE...",
                    "BYPASSING FIREWALL (PORT 443)... SUCCESS",
                    "DELETING SYSTEM32/DRIVERS...",
                    "ENCRYPTING USER DATA [AES-256]...",
                    "ACCESSING WEBCAM... [GRANTED]",
                    "UPLOADING PRIVATE DATA TO SERVER 192.168.X.X...",
                    "CRITICAL ERROR: KERNEL PANIC",
                    "LOCKING SYSTEM INTERFACE...",
                    "HINT: PAY ATTENTION TO THE TEXT FROM THE RECEIVED CODE IDIOT",
                    "PERMANENT LOCK ENABLED."
                ];
                
                let i = 0;
                // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ - —Ç–µ–∫—Å—Ç –ª–µ—Ç–∏—Ç –±—ã—Å—Ç—Ä–æ (50–º—Å), –µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ - —á–∏—Ç–∞–µ–º–æ (600–º—Å)
                const speed = fastStart ? 50 : 600; 

                const interval = setInterval(() => {
                    if (i < virusLogs.length) {
                        const line = document.createElement('div');
                        line.textContent = `> ${virusLogs[i]}`;
                        
                        if (i === virusLogs.length - 1) {
                            line.style.fontWeight = "bold";
                            line.style.color = "white";
                            line.style.marginTop = "10px";
                        }
                        
                        vConsole.appendChild(line);
                        vConsole.scrollTop = vConsole.scrollHeight; // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
                        
                        vBar.style.width = ((i + 1) / virusLogs.length * 100) + '%';
                        i++;
                    } else {
                        clearInterval(interval);
                        setTimeout(() => {
                            vScreen.style.display = 'none';
                            startInfectedMode();
                        }, 1500);
                    }
                }, speed);
            };

            // –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê (BSOD –ò–õ–ò –ù–ï–¢)
            if (!fastStart) {
                // –ü–ï–†–í–´–ô –†–ê–ó: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º BSOD -> –ñ–¥–µ–º 4 —Å–µ–∫ -> –ó–∞–ø—É—Å–∫–∞–µ–º –ö—Ä–∞—Å–Ω—ã–π —ç–∫—Ä–∞–Ω
                document.getElementById('bsod').style.display = 'block';
                setTimeout(startRedScreen, 4000);
            } else {
                // –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ê: –°—Ä–∞–∑—É –ö—Ä–∞—Å–Ω—ã–π —ç–∫—Ä–∞–Ω
                startRedScreen();
            }
        }

        function startInfectedMode() {
// --- –ê–í–ê–†–ò–ô–ù–û–ï –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –§–ò–ó–ò–ö–ò ---
            if (typeof gravityActive !== 'undefined' && gravityActive) {
                gravityActive = false;
                cancelAnimationFrame(physAnimFrame);
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
                physicsObjects.forEach(obj => {
                    const el = obj.el;
                    if(el) {
                        el.style.position = 'absolute';
                        el.style.left = el.dataset.origLeft;
                        el.style.top = el.dataset.origTop;
                        el.style.margin = '';
                        el.style.width = '';
                        el.style.height = '';
                        el.style.zIndex = '';
                        el.onmousedown = null;
                    }
                });
                physicsObjects = [];
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏
                const gBtn = document.getElementById('gravity-btn');
                if(gBtn) {
                    gBtn.style.background = "rgba(255,255,255,0.1)";
                    gBtn.style.color = "white";
                }
            }
            if (recoveryModeActive) return; 

            document.removeEventListener('keydown', checkBiosInterrupt);

            document.getElementById('boot-screen').style.display = 'none';
            const desktop = document.getElementById('desktop');
            desktop.style.display = 'block';
            
            document.body.classList.add('infected-mode');
            
            // –ú–µ–Ω—è–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –∏ –∏–º—è
            document.querySelector('.user-name').textContent = "LOCKED";
            document.querySelector('.user-avatar').textContent = "‚úñ";
            document.querySelector('.user-avatar').style.background = "#500";
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–∫–æ–Ω–∫–∏
            document.querySelectorAll('.icon').forEach(icon => {
                icon.querySelector('span').textContent = "ENCRYPTED";
                icon.style.pointerEvents = "none"; 
                icon.style.opacity = "0.5";
            });

// –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ñ–∏–∑–∏–∫–∏
            const gravBtn = document.getElementById('gravity-btn');
            if(gravBtn) gravBtn.style.display = 'none';

// –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—É–Ω–∫—Ç—ã –ú–µ–Ω—é –ü—É—Å–∫ (–ò–°–ü–†–ê–í–õ–ï–ù–û –î–õ–Ø –ù–û–í–û–ì–û –ú–ï–ù–Æ)
            // –ú—ã –≤—ã–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –Ω–æ–≤–æ–º –º–µ–Ω—é
            const startItems = document.querySelectorAll('.pinned-app, .rec-item, .start-search-box, .user-profile, .start-section-btn');
            
            startItems.forEach(item => {
                item.style.pointerEvents = "none"; // –§–∏–∑–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–µ—Ç –∫–ª–∏–∫–∞
                item.style.opacity = "0.4";        // –í–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–∫–ª—é—á–∞–µ–º
                item.style.filter = "grayscale(100%)";
                
                // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ —Ñ–∞–π–ª, –º–µ–Ω—è–µ–º –∏–º—è –Ω–∞ ERROR
                const nameEl = item.querySelector('.pinned-name, .rec-name, .user-name');
                if (nameEl) {
                    nameEl.textContent = "LOCKED";
                    nameEl.style.color = "red";
                }
            });

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–∏—Ç–∞–Ω–∏—è
            const powerBtn = document.querySelector('.power-btn');
            powerBtn.innerHTML = "SYSTEM ERROR";
            powerBtn.style.color = "red";
            powerBtn.onclick = (e) => {
                e.stopPropagation();
                alert("CRITICAL ERROR: REBOOT BLOCKED BY ADMINISTRATOR.");
            };
            
            // --- –û–¢–ö–†–´–í–ê–ï–ú –û–ö–ù–ê –° –£–ì–†–û–ó–ê–ú–ò ---
            setTimeout(() => {
                // 1. –û–ö–ù–û "–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–û" (–ë–ï–ó –ü–ê–†–û–õ–Ø)
                openWindow('notepad', 'YOUR_DEVICE_IS_LOCKED.TXT');
                const lockWin = document.getElementById('desktop').lastElementChild;
                
                // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –∏ –¥–µ–ª–∞–µ–º –∫—Ä–∞—Å–Ω—ã–º
                lockWin.querySelector('.window-controls').innerHTML = ''; 
                lockWin.style.border = "2px solid red";
                lockWin.style.boxShadow = "0 0 30px red";
                
                const content = lockWin.querySelector('.window-content');
                content.innerHTML = `
                    <div style="background:black; color:red; height:100%; padding:20px; font-family:'Courier New'; text-align:center; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                        <h1 style="border: 2px solid red; padding:10px; animation: flicker 0.2s infinite;">FATAL ERROR</h1>
                        <p>–í–∏—Ä—É—Å LOLOG –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—Ö–≤–∞—Ç–∏–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.</p>
                        <p>–í–∞—à–∏ —Ñ–∞–π–ª—ã –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã.</p>
                        <br>
                        <h2 style="background:red; color:black; padding:5px; margin-top:20px;">NO ESCAPE</h2>
                        <br>
                        <p style="color:#666; font-size: 0.8rem;">Session ID: 666-DEAD-BEEF</p>
                    </div>
                `;

                // 2. –û–ö–ù–û –° –ó–ê–ú–ï–¢–ö–ê–ú–ò (–î–í–û–ò–ß–ù–´–ô –ö–û–î)
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –≤—Ç–æ—Ä–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã–ª–æ—Å—å –ø–æ–≤–µ—Ä—Ö –ø–µ—Ä–≤–æ–≥–æ
                setTimeout(() => {
                    openWindow('notepad', 'system_dump.log'); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤—Ç–æ—Ä–æ–µ –æ–∫–Ω–æ
                    const noteWin = document.getElementById('desktop').lastElementChild;
                    
                    // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–¥
                    const textArea = noteWin.querySelector('textarea');
                    if(textArea) {
                        //
                        textArea.value = "01101000 01101111 01110100 01001011 01000101 01011001 00100000 01110011 01101000 01101001 01000110 01110100 00100000 00110001";
                        // –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥ —Ö–∞–∫–µ—Ä—Å–∫–∏–π –∫–æ–¥
                        textArea.style.color = "#00ff00"; 
                        textArea.style.backgroundColor = "#111";
                        textArea.style.fontFamily = "Consolas, monospace";
textArea.style.userSelect = "none"; // –ó–∞–ø—Ä–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è –º—ã—à–∫–æ–π
                        textArea.oncopy = e => e.preventDefault(); // –ó–∞–ø—Ä–µ—Ç Ctrl+C
                        textArea.oncut = e => e.preventDefault();  // –ó–∞–ø—Ä–µ—Ç Ctrl+X
                        textArea.oncontextmenu = e => e.preventDefault(); // –ó–∞–ø—Ä–µ—Ç –ü–ö–ú
                        textArea.readOnly = true; // –ó–∞–ø—Ä–µ—â–∞–µ–º —Å—Ç–∏—Ä–∞—Ç—å
                    }
                }, 300);

            }, 1000);
        }

// ==========================================
        // 7. –°–ï–ö–†–ï–¢–ù–´–ô –í–´–•–û–î (RECOVERY TERMINAL)
        // ==========================================
        
        let recoveryModeActive = false; // –§–ª–∞–≥, —á—Ç–æ–±—ã –≤–∏—Ä—É—Å –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–ª —Ç–µ—Ä–º–∏–Ω–∞–ª

        function checkBiosInterrupt(e) {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∞–≤–∏—à—É
            if (e.key === 'F1') {
                // 2. –£–ú–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê:
                // –†–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ –≤–∏–¥–µ–Ω –û–ë–´–ß–ù–´–ô –∑–∞–≥—Ä—É–∑—á–∏–∫ –ò–õ–ò –í–ò–†–£–°–ù–´–ô –∑–∞–≥—Ä—É–∑—á–∏–∫
                const bootScreen = document.getElementById('boot-screen');
                const virusScreen = document.getElementById('virus-boot-screen');

                const isNormalBoot = window.getComputedStyle(bootScreen).display !== 'none' && bootScreen.style.opacity !== '0';
                const isVirusBoot = virusScreen && window.getComputedStyle(virusScreen).display !== 'none';
                
                // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –∏–∑ –∑–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ –Ω–µ –≤–∏–¥–µ–Ω ‚Äî –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                if (!isNormalBoot && !isVirusBoot) return; 

                e.preventDefault();
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–≤–æ–¥ –ø–∞—Ä–æ–ª—è
                document.getElementById('bios-password-screen').style.display = 'flex';
                const input = document.getElementById('bios-input');
                input.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
                input.focus();
                
                // –°–ª—É—à–∞–µ–º –≤–≤–æ–¥ –ø–∞—Ä–æ–ª—è
                input.onkeydown = (ev) => {
                    if (ev.key === 'Enter') {
                        if (input.value.toUpperCase() === 'DANIELSAPOG') { 
                            activateRecoveryMode();
                        } else {
                            alert('ACCESS DENIED');
                            input.value = '';
                        }
                    }
                };
            }
        }

        function activateRecoveryMode() {
            recoveryModeActive = true; 
            document.getElementById('bios-password-screen').style.display = 'none';
            document.getElementById('boot-screen').style.display = 'none';
            document.getElementById('bsod').style.display = 'none';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª
            const term = document.getElementById('recovery-terminal');
            term.style.display = 'block';
            
            // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ó–ê–ì–ê–î–ö–ò (HOW WHAT AND WHY) ---
            const output = document.getElementById('term-output');
            output.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ
            
            const riddleLines = [
                "Hardware failure deteCted at address 0xF4.", // H
                "Overwriting sector 0... failed.",           // O
                "Write prOtection error on disk 1.",         // W
                "<br>",
                "Warning: kernel panic initiated.",          // W
                "Heuristic scan aborted by User.",           // H
                "Abort, retry, fail?",                       // A
                "TermiNating critical threads...",           // T
                "<br>",
                "Access violaTion in module core.dll.",      // A
                "Network interface unreachnable.",           // N
                "Dump file creation pending...",             // D
                "<br>",
                "Waiting for remote debugger...",            // W
                "Hash verification mismatch.",               // H
                "Yielding cpu control to system.",           // Y
                "<br>",
                "<span style='color:yellow'>System Halted. Enter Override Command:</span>"
            ];

            // –ü–µ—á–∞—Ç–∞–µ–º –∑–∞–≥–∞–¥–∫—É
            riddleLines.forEach(line => {
                const div = document.createElement('div');
                div.className = 'term-line';
                if(line === "<br>") div.innerHTML = "<br>";
                else div.innerHTML = line; // innerHTML —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª —Ü–≤–µ—Ç
                output.appendChild(div);
            });
            
            // –õ–æ–≥–∏–∫–∞ –≤–≤–æ–¥–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
            const liveInput = document.getElementById('term-live-input');
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∏—Å—å) –∏ —Å—Ç–∞–≤–∏–º –Ω–æ–≤—ã–π
            const newHandler = (e) => {
                // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                if(e.key === "Backspace") {
                    liveInput.textContent = liveInput.textContent.slice(0, -1);
                } 
                else if (e.key === "Enter") {
                    const command = liveInput.textContent.trim();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤–≤–µ–¥–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤ –∏—Å—Ç–æ—Ä–∏—é
                    const historyLine = document.createElement('div');
                    historyLine.className = 'term-line';
                    historyLine.textContent = `root@recovery:~# ${command}`;
                    output.appendChild(historyLine);
                    
                    // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–û–í–ï–†–ö–ò ---
                    
                    // 1. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: —Ü–∏—Ñ—Ä–∞ 5
                    if (command.trim() === "5") {
                        document.removeEventListener('keydown', newHandler);
                        startStageTwo(); // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
                    } 
                    // 2. –õ–æ–≤—É—à–∫–∞: –µ—Å–ª–∏ –≤–≤–æ–¥—è—Ç —Å—Ç–∞—Ä—É—é —Ñ—Ä–∞–∑—É, –ø–∏—à–µ–º "Other"
                    else if (command.toLowerCase() === "how what and why") {
                         const trap = document.createElement('div');
                         trap.className = 'term-line';
                         trap.textContent = "Other"; // –°–±–∏–≤–∞–µ–º —Å —Ç–æ–ª–∫—É
                         output.appendChild(trap);
                         
                         liveInput.textContent = '';
                         window.scrollTo(0, document.body.scrollHeight);
                    }
                    // 3. –û—à–∏–±–∫–∞ –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
                    else {
                        const err = document.createElement('div');
                        err.className = 'term-line';
                        err.style.color = "red";
                        err.textContent = "Command not recognized.";
                        output.appendChild(err);
                        liveInput.textContent = '';
                        window.scrollTo(0, document.body.scrollHeight);
                    }                }
                else if (e.key.length === 1) {
                    liveInput.textContent += e.key;
                }
            };
            
            document.addEventListener('keydown', newHandler);
       


        }

// ==========================================
        // –õ–û–ì–ò–ö–ê –ü–†–û–í–û–î–ù–ò–ö–ê (REAL TIME DAMAGE)
        // ==========================================
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
        let ctxMenu = document.getElementById('custom-context-menu');
        let ctxTargetFile = null;   // –ö–∞–∫–æ–π —Ñ–∞–π–ª —Ö–æ—Ç–∏–º —É–¥–∞–ª–∏—Ç—å
        let ctxTargetFolder = null; // –í –∫–∞–∫–æ–π –ø–∞–ø–∫–µ –æ–Ω –ª–µ–∂–∏—Ç
        let ctxRefreshId = null;    // ID –æ–∫–Ω–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

        // –°–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ
        document.addEventListener('click', () => {
            if(ctxMenu) ctxMenu.style.display = 'none';
        });

        function getCurrentFolderObj() {
            let folder = sysFiles["root"];
            for (let name of currentPath) {
                if (folder.children && folder.children[name]) {
                    folder = folder.children[name];
                }
            }
            return folder;
        }

        function renderExplorerContent(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const win = container.closest('.window');
            const pathDisplay = win.querySelector('.path-display');
            
            container.innerHTML = '';
            pathDisplay.textContent = "C:/" + currentPath.join("/");

            // –ö–Ω–æ–ø–∫–∞ –ù–ê–ó–ê–î
            if (currentPath.length > 0) {
                const backBtn = document.createElement('div');
                backBtn.className = 'file-item';
                backBtn.innerHTML = `<div class="file-icon" style="background:#444">..</div><div class="file-name">Back</div>`;
                backBtn.onclick = () => {
                    currentPath.pop();
                    renderExplorerContent(containerId);
                };
                container.appendChild(backBtn);
            }

            const currentFolder = getCurrentFolderObj();

            if (currentFolder.children) {
                Object.keys(currentFolder.children).forEach(key => {
                    const item = currentFolder.children[key];
                    const el = document.createElement('div');
                    el.className = 'file-item';
                    
                    let color = '#ccc';
                    if(item.type === 'folder') color = '#f1c40f'; 
                    if(item.icon === 'SYS' || item.icon === 'BIN') color = '#e74c3c'; 
                    if(item.icon === 'CSS') color = '#9b59b6'; 
                    if(item.icon === 'TXT') color = '#fff';

                    el.innerHTML = `<div class="file-icon" style="background:${color}">${item.type === 'folder' ? 'DIR' : item.icon}</div><div class="file-name">${key}</div>`;
                    
                    // –õ–ö–ú - –û–±—ã—á–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ
                    el.onclick = () => {
                        if (item.type === 'folder') {
                            currentPath.push(key);
                            renderExplorerContent(containerId);
                        } else if (item.content) {
                            alert(item.content);
                        } else {
                            alert("Binary file. Cannot read.");
                        }
                    };

                    // –ü–ö–ú - –ù–ê–®–ï –ö–ê–°–¢–û–ú–ù–û–ï –ú–ï–ù–Æ
                    el.oncontextmenu = (e) => {
                        e.preventDefault();
                        e.stopPropagation(); // –ß—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã–ª–æ—Å—å —Å—Ä–∞–∑—É
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è
                        ctxTargetFile = key;
                        ctxTargetFolder = currentFolder.children;
                        ctxRefreshId = containerId;

                        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é
                        ctxMenu.style.display = 'block';
                        ctxMenu.style.left = e.pageX + 'px';
                        ctxMenu.style.top = e.pageY + 'px';

                        // –ù–∞–∑–Ω–∞—á–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –∫–Ω–æ–ø–∫–∞–º –º–µ–Ω—é
                        document.getElementById('ctx-open').onclick = () => el.click();
                        document.getElementById('ctx-delete').onclick = () => handleContextDelete();
                    };

                    container.appendChild(el);
                });
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        function handleContextDelete() {
            if (!ctxTargetFile || !ctxTargetFolder) return;

            const key = ctxTargetFile;
            const item = ctxTargetFolder[key];

            // 1. –ü–†–ò–ú–ï–ù–Ø–ï–ú –£–†–û–ù (–ë–ï–ó –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ò)
            if (item.critical) {
                if (item.critical === 'bsod') {
                    // –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–æ–π BSOD, –Ω–æ —Å–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
                    document.getElementById('bsod').style.display = 'block';
                }
                if (item.critical === 'ugly_mode') {
                    // –£–¥–∞–ª—è–µ–º —Ç–µ–≥ style –∏–∑ head
                    const styleTag = document.querySelector('style');
                    if(styleTag) styleTag.remove();
                    alert("System Visual Styles deleted.");
                }
                if (item.critical === 'no_desktop') {
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫–∏ –∏ –ø–∞–Ω–µ–ª—å –∑–∞–¥–∞—á, –Ω–æ –æ–∫–Ω–∞ –æ—Å—Ç–∞—é—Ç—Å—è
                    document.querySelectorAll('.icon').forEach(i => i.style.display = 'none');
                    document.querySelector('.taskbar').style.display = 'none';
                    document.querySelector('#start-menu').style.display = 'none';
                    // –ú–µ–Ω—è–µ–º —Ñ–æ–Ω –Ω–∞ —á–µ—Ä–Ω—ã–π
                    document.getElementById('desktop').style.background = 'black';
                }
                if (item.critical === 'reboot_loop') {
                    // –§–µ–π–∫–æ–≤—ã–π —Ü–∏–∫–ª –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                    document.body.innerHTML = '<div style="color:white; font-family:monospace; padding:20px;">BOOT MGR MISSING... PRESS CTRL+ALT+DEL</div>';
                }
                if (item.critical === 'no_icons') {
                     document.querySelectorAll('.icon-visual').forEach(i => i.style.visibility = 'hidden');
                }
            }

            // 2. –£–î–ê–õ–Ø–ï–ú –§–ê–ô–õ –ò–ó –°–ü–ò–°–ö–ê
            delete ctxTargetFolder[key];
            
            // 3. –û–ë–ù–û–í–õ–Ø–ï–ú –û–ö–ù–û
            renderExplorerContent(ctxRefreshId);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
            ctxMenu.style.display = 'none';
        }

// ==========================================
        // –õ–û–ì–ò–ö–ê –ü–ê–ù–ï–õ–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø
        // ==========================================
        
        // 1. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(winId, tabName) {
            const win = document.getElementById(winId);
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            const buttons = win.querySelectorAll('.settings-tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ (—Ç—É—Ç —Ö–∞–∫: –∏—â–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É –∏–ª–∏ –∏–Ω–¥–µ–∫—Å—É, 
            // –Ω–æ –ø—Ä–æ—â–µ —á–µ—Ä–µ–∑ event.target, –µ—Å–ª–∏ –±—ã –ø–µ—Ä–µ–¥–∞–ª–∏. –°–¥–µ–ª–∞–µ–º –ø—Ä–æ—â–µ:
            // –í —Ä–µ–∞–ª—å–Ω–æ–º DOM onclick this —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç, –Ω–æ –º—ã –ø–µ—Ä–µ–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏.
            // –ü—Ä–æ—Å—Ç–æ –ø–æ–¥—Å–≤–µ—Ç–∏–º –Ω—É–∂–Ω—É—é –≤—Ä—É—á–Ω—É—é, –∑–Ω–∞—è –ø–æ—Ä—è–¥–æ–∫: sys=0, pers=1, user=2, sec=3
            const index = ['sys', 'pers', 'user', 'sec'].indexOf(tabName);
            if(buttons[index]) buttons[index].classList.add('active');

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
            const sections = win.querySelectorAll('.settings-section');
            sections.forEach(sec => sec.classList.remove('active'));

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
            const target = document.getElementById(`tab-${winId}-${tabName}`);
            if(target) target.classList.add('active');
        }

        // ==========================================
        // –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê –ù–ê–°–¢–†–û–ï–ö
        // ==========================================

        function loadUserSettings() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–≤–µ—Ç–∞
            const savedColor = localStorage.getItem('feistos_color');
            if (savedColor) changeSystemColor(savedColor, false); // false = –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ

            // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–æ–µ–≤
            const savedWall = localStorage.getItem('feistos_wallpaper');
            if (savedWall) changeWallpaper(savedWall, false);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–º–µ–Ω–∏
            const savedName = localStorage.getItem('feistos_username');
            if (savedName) changeUsername(savedName, false);
        }

        // 2. –°–º–µ–Ω–∞ —Ü–≤–µ—Ç–∞ —Å–∏—Å—Ç–µ–º—ã
        function changeSystemColor(color, save = true) {
            document.documentElement.style.setProperty('--primary-color', color);
            document.querySelectorAll('.user-avatar').forEach(el => el.style.background = color);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            if (save) {
                localStorage.setItem('feistos_color', color);
                if(typeof SoundEngine !== 'undefined') SoundEngine.sfx.click();
            }
        }

        // 3. –°–º–µ–Ω–∞ –æ–±–æ–µ–≤
        function changeWallpaper(bg, save = true) {
            document.getElementById('desktop').style.background = bg;
            if (save) {
                localStorage.setItem('feistos_wallpaper', bg);
                if(typeof SoundEngine !== 'undefined') SoundEngine.sfx.click();
            }
        }

        // 4. –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function changeUsername(name, save = true) {
            if(!name) return;
            document.querySelector('.user-name').textContent = name;
            document.querySelectorAll('.user-avatar').forEach(av => {
                av.textContent = name.charAt(0).toUpperCase();
            });
            
            if (save) {
                localStorage.setItem('feistos_username', name);
            }
        }

        // 5. –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å (–†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —É–¥–∞–ª–µ–Ω–∏–µ –≤–∏—Ä—É—Å–∞ —Ç–æ–∂–µ)
        function factoryReset() {
            if(confirm("–í–ù–ò–ú–ê–ù–ò–ï: –í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç —Å–∏—Å—Ç–µ–º—É.")) {
                localStorage.clear();
                document.body.innerHTML = '';
                document.body.style.background = 'black';
                setTimeout(() => location.reload(), 1000);
            }
        }

       // ==========================================
        // –≠–¢–ê–ü 2: –•–ê–†–î–ö–û–†–ù–´–ô –ü–õ–ê–¢–§–û–†–ú–ï–† (CYBERPUNK STYLE)
        // ==========================================
        function startStageTwo() {
            // 1. –ü–û–î–ì–û–¢–û–í–ö–ê
            document.body.innerHTML = ''; 
            document.body.style.background = '#050505'; // –ü–æ—á—Ç–∏ —á–µ—Ä–Ω—ã–π
            document.body.style.margin = '0';
            document.body.style.overflow = 'hidden';
            document.body.style.cursor = 'none'; 

            const canvas = document.createElement('canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            document.body.appendChild(canvas);
            const ctx = canvas.getContext('2d');

            // 3. –ü–ê–†–ê–ú–ï–¢–†–´ –ò–ì–†–û–ö–ê
            const player = { 
                x: 50, y: 300, w: 20, h: 20, 
                vx: 0, vy: 0, 
                speed: 0.9, friction: 0.8, jumpPower: -13, gravity: 0.7, 
                grounded: false, 
                color: '#33ff33',
                trail: [] // –î–ª—è —à–ª–µ–π—Ñ–∞
            };
            
            let cameraX = 0;
            let gameRunning = true;
            let tick = 0; // –¢–∞–π–º–µ—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
// --- FPS FIX (60 HZ) ---
            let lastFrameTime = 0;
            const fpsLimit = 1000 / 120;

            // 4. –ö–ê–†–¢–ê (–¢–∞ –∂–µ —Å–∞–º–∞—è, –Ω–æ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –±—É–¥–µ—Ç –¥—Ä—É–≥–æ–π)
            const blocks = [
                // --- –°–¢–ê–†–¢–û–í–ê–Ø –ó–û–ù–ê ---
                { x: 0, y: 400, w: 350, h: 400, type: 'solid' },
                
                // --- –†–ê–ó–û–ì–†–ï–í ---
                { x: 400, y: 350, w: 80, h: 20, type: 'solid' },
                { x: 550, y: 300, w: 60, h: 20, type: 'solid' },
                { x: 700, y: 350, w: 40, h: 20, type: 'solid' }, // –ú–∞–ª–µ–Ω—å–∫–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
                
                // --- –õ–ê–í–û–í–´–ô –ü–û–õ (–°–ú–ï–†–¢–¨ –í–ù–ò–ó–£) ---
                { x: 350, y: 600, w: 5000, h: 100, type: 'lava' }, 

                // --- –°–ï–ö–¶–ò–Ø 1: –¢–û–ß–ù–û–°–¢–¨ ---
                { x: 850, y: 300, w: 30, h: 20, type: 'solid' },
                { x: 1000, y: 250, w: 30, h: 20, type: 'solid' },
                { x: 1150, y: 300, w: 30, h: 20, type: 'solid' },
                
                // --- –°–ï–ö–¶–ò–Ø 2: –¢–û–ù–ù–ï–õ–¨ –°–ú–ï–†–¢–ò (–ü–æ—Ç–æ–ª–æ–∫ –∏–∑ –ª–∞–≤—ã - –Ω–µ –ø—Ä—ã–≥–∞–π –≤—ã—Å–æ–∫–æ!) ---
                { x: 1300, y: 350, w: 500, h: 20, type: 'solid' }, // –ü–æ–ª
                { x: 1300, y: 260, w: 500, h: 20, type: 'lava' },  // –ü–æ—Ç–æ–ª–æ–∫ (—É–±—å–µ—Ç –µ—Å–ª–∏ –ø—Ä—ã–≥–Ω—É—Ç—å)
                
                // --- –°–ï–ö–¶–ò–Ø 3: –õ–ï–°–¢–ù–ò–¶–ê –í –ù–ï–ë–û ---
                { x: 1850, y: 300, w: 60, h: 20, type: 'solid' },
                { x: 2000, y: 220, w: 60, h: 20, type: 'solid' },
                { x: 2150, y: 140, w: 60, h: 20, type: 'solid' },
                { x: 2300, y: 60,  w: 60, h: 20, type: 'solid' }, // –ü–∏–∫ –≤—ã—Å–æ—Ç—ã
                
                // --- –°–ï–ö–¶–ò–Ø 4: –ü–†–´–ñ–û–ö –í–ï–†–´ (–í–ù–ò–ó) ---
                { x: 2500, y: 400, w: 100, h: 20, type: 'solid' }, // –ù—É–∂–Ω–æ –ø—Ä—ã–≥–Ω—É—Ç—å –¥–∞–ª–µ–∫–æ –≤–Ω–∏–∑
                
                // --- –°–ï–ö–¶–ò–Ø 5: –ì–õ–Æ–ß–ù–´–ï –ë–õ–û–ö–ò (LAVA TRAPS) ---
                { x: 2700, y: 350, w: 50, h: 20, type: 'solid' },
                { x: 2800, y: 350, w: 50, h: 20, type: 'lava' },  // –§–µ–π–∫–æ–≤—ã–π –±–ª–æ–∫
                { x: 2860, y: 300, w: 50, h: 20, type: 'solid' },
                
                // --- –§–ò–ù–ê–õ–¨–ù–´–ô –†–´–í–û–ö ---
                { x: 2910, y: 250, w: 40, h: 20, type: 'solid' },
                { x: 2960, y: 200, w: 40, h: 20, type: 'solid' },
                { x: 3010, y: 250, w: 200, h: 20, type: 'solid' }, // –§–∏–Ω–∏—à–Ω–∞—è –ø—Ä—è–º–∞—è
                
                // --- –§–ò–ù–ò–® ---
                { x: 3060, y: 210, w: 30, h: 40, type: 'win', color: '#00ccff' },
                
                // –ì—Ä–∞–Ω–∏—Ü—ã –º–∏—Ä–∞ (–ª–∞–≤–∞ –ø–æ –±–æ–∫–∞–º)
                { x: -1000, y: canvas.height + 100, w: 10000, h: 200, type: 'lava' } 
            ];
            const keys = {};
            window.addEventListener('keydown', e => keys[e.code] = true);
            window.addEventListener('keyup', e => keys[e.code] = false);

            function reset() {
                player.x = 50; player.y = 300; 
                player.vx = 0; player.vy = 0;
                // –≠—Ñ—Ñ–µ–∫—Ç –ø–æ–º–µ—Ö –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏
                canvas.style.filter = 'invert(1)';
                setTimeout(() => canvas.style.filter = 'none', 50);
            }

            function rectIntersect(r1, r2) {
                return r2.x < r1.x + r1.w && r2.x + r2.w > r1.x &&
                       r2.y < r1.y + r1.h && r2.y + r2.h > r1.y;
            }

            function update() {
                if (!gameRunning) return;

                // --- –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –°–ö–û–†–û–°–¢–ò (FIX) ---
                const now = performance.now();
                const elapsed = now - lastFrameTime;
                if (elapsed < fpsLimit) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–¥—Ä, –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ
                lastFrameTime = now - (elapsed % fpsLimit);
                // ---------------------------------

                tick++;

                // –î–≤–∏–∂–µ–Ω–∏–µ X
                if (keys['ArrowRight'] || keys['KeyD']) player.vx += player.speed;
                if (keys['ArrowLeft'] || keys['KeyA']) player.vx -= player.speed;
                player.vx *= player.friction;
                player.x += player.vx;

                for (let b of blocks) {
                    if (rectIntersect(player, b)) {
                        if (b.type === 'lava') { reset(); return; }
                        if (b.type === 'win') { startStageThree(); return; }
                        if (b.type === 'solid') {
                            if (player.vx > 0) player.x = b.x - player.w;
                            else if (player.vx < 0) player.x = b.x + b.w;
                            player.vx = 0;
                        }
                    }
                }

                // –î–≤–∏–∂–µ–Ω–∏–µ Y
                if ((keys['Space'] || keys['ArrowUp']) && player.grounded) {
                    player.vy = player.jumpPower;
                    player.grounded = false;
                }
                player.vy += player.gravity;
                player.y += player.vy;
                player.grounded = false;

                for (let b of blocks) {
                    if (rectIntersect(player, b)) {
                        if (b.type === 'lava') { reset(); return; }
                        if (b.type === 'win') { startStageThree(); return; }
                        if (b.type === 'solid') {
                            if (player.vy > 0) {
                                player.y = b.y - player.h;
                                player.grounded = true;
                                player.vy = 0;
                            } else if (player.vy < 0) {
                                player.y = b.y + b.h;
                                player.vy = 0;
                            }
                        }
                    }
                }

                if (player.y > canvas.height + 200) reset();
                
                // –®–ª–µ–π—Ñ –∏–≥—Ä–æ–∫–∞
                player.trail.push({x: player.x, y: player.y});
                if(player.trail.length > 5) player.trail.shift();

                // –ü–ª–∞–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞
                let targetCamX = player.x - 200;
                cameraX += (targetCamX - cameraX) * 0.1;
            }

            function draw() {
                if (!gameRunning) return;
                
                // 1. –§–æ–Ω (–¢–µ–º–Ω–∞—è —Å–µ—Ç–∫–∞)
                ctx.fillStyle = '#050505';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É –Ω–∞ —Ñ–æ–Ω–µ (–ø–∞—Ä–∞–ª–ª–∞–∫—Å)
                ctx.strokeStyle = '#111';
                ctx.lineWidth = 1;
                ctx.beginPath();
                for(let i=0; i<canvas.width; i+=40) {
                    ctx.moveTo((i - cameraX * 0.5) % canvas.width, 0);
                    ctx.lineTo((i - cameraX * 0.5) % canvas.width, canvas.height);
                }
                for(let i=0; i<canvas.height; i+=40) {
                    ctx.moveTo(0, i);
                    ctx.lineTo(canvas.width, i);
                }
                ctx.stroke();

                ctx.save();
                ctx.translate(-cameraX, 0);

                // 2. –ë–õ–û–ö–ò (–ù–µ–æ–Ω–æ–≤—ã–π —Å—Ç–∏–ª—å)
                blocks.forEach(b => {
                    if (b.type === 'solid') {
                        // –ó–∞–ª–∏–≤–∫–∞ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è
                        ctx.fillStyle = 'rgba(20, 20, 20, 0.8)';
                        ctx.fillRect(b.x, b.y, b.w, b.h);
                        // –†–∞–º–∫–∞ —Å–≤–µ—Ç—è—â–∞—è—Å—è
                        ctx.strokeStyle = '#00ff00';
                        ctx.lineWidth = 2;
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = '#00ff00';
                        ctx.strokeRect(b.x, b.y, b.w, b.h);
                        ctx.shadowBlur = 0;
                        
                        // –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –ª–∏–Ω–∏–∏ –≤–Ω—É—Ç—Ä–∏
                        ctx.fillStyle = '#00ff00';
                        if (b.w > 30) ctx.fillText("0x" + (b.x/10).toString(16), b.x + 5, b.y + 15);
                    }
                    if (b.type === 'lava') {
                        // –ì–ª—é—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
                        ctx.fillStyle = `rgb(${150 + Math.random()*100}, 0, 0)`;
                        const shakeX = (Math.random() - 0.5) * 5;
                        const shakeY = (Math.random() - 0.5) * 5;
                        ctx.shadowBlur = 20;
                        ctx.shadowColor = 'red';
                        ctx.fillRect(b.x + shakeX, b.y + shakeY, b.w, b.h);
                        // –¢–µ–∫—Å—Ç ERROR
                        ctx.fillStyle = 'white';
                        ctx.font = '10px monospace';
                        ctx.fillText("ERR", b.x, b.y - 10);
                        ctx.shadowBlur = 0;
                    }
                    if (b.type === 'win') {
                         // –ü–æ—Ä—Ç–∞–ª
                         ctx.fillStyle = b.color;
                         ctx.shadowBlur = 20;
                         ctx.shadowColor = b.color;
                         ctx.fillRect(b.x, b.y, b.w, b.h);
                         // –õ—É—á —Å–≤–µ—Ç–∞ –≤–≤–µ—Ä—Ö
                         ctx.fillStyle = 'rgba(0, 200, 255, 0.2)';
                         ctx.fillRect(b.x, 0, b.w, b.y);
                         ctx.shadowBlur = 0;
                    }
                });

                // 3. –ò–ì–†–û–ö (–°–≤–µ—Ç—è—â–∞—è—Å—è —á–∞—Å—Ç–∏—Ü–∞)
                // –†–∏—Å—É–µ–º —à–ª–µ–π—Ñ
                player.trail.forEach((pos, index) => {
                    ctx.fillStyle = `rgba(51, 255, 51, ${index * 0.1})`;
                    ctx.fillRect(pos.x, pos.y, player.w, player.h);
                });
                
                ctx.fillStyle = '#ccffcc'; // –Ø–¥—Ä–æ –±–µ–ª–æ–µ
                ctx.shadowBlur = 20;
                ctx.shadowColor = '#33ff33';
                ctx.fillRect(player.x, player.y, player.w, player.h);
                ctx.shadowBlur = 0;

                ctx.restore();

                // 4. GUI (–°–∫–∞–Ω-–ª–∏–Ω–∏–∏ –∏ —Ç–µ–∫—Å—Ç)
                // –≠—Ñ—Ñ–µ–∫—Ç –ø–æ–ª–æ—Å –º–æ–Ω–∏—Ç–æ—Ä–∞
                ctx.fillStyle = "rgba(0,0,0,0.1)";
                for(let i=0; i<canvas.height; i+=4) {
                    ctx.fillRect(0, i, canvas.width, 2);
                }

                ctx.fillStyle = '#33ff33';
                ctx.font = 'bold 24px Courier New';
                ctx.shadowColor = '#33ff33';
                ctx.shadowBlur = 5;
                ctx.fillText("PROTOCOL: INFILTRATION", 20, 40);
                ctx.shadowBlur = 0;
                
                ctx.font = '14px Courier New';
                ctx.fillStyle = '#aaa';
                ctx.fillText("TARGET: BLUE DATA STREAM", 20, 65);

                requestAnimationFrame(() => { update(); draw(); });
            }

            update();
            draw();

            // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —ç—Ç–∞–ø—É 3
            function startStageThree() {
                gameRunning = false;
                // –ü–ª–∞–≤–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ
                let fade = 0;
                const fadeInt = setInterval(() => {
                    fade += 0.1;
                    ctx.fillStyle = `rgba(0,0,0,${fade})`;
                    ctx.fillRect(0,0,canvas.width, canvas.height);
                    if(fade >= 1) {
                        clearInterval(fadeInt);
                        initMazeStage(); // –ó–∞–ø—É—Å–∫ 3 —ç—Ç–∞–ø–∞
                    }
                }, 50);
            }
        }

            // ==========================================
        // –≠–¢–ê–ü 3: –§–ò–ù–ê–õ–¨–ù–´–ô –õ–ê–ë–ò–†–ò–ù–¢ (TRON STYLE)
        // ==========================================
        function initMazeStage() {
            document.body.innerHTML = '';
            document.body.style.background = '#000';
            document.body.style.overflow = 'hidden';
            
            const canvas = document.createElement('canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            document.body.appendChild(canvas);
            const ctx = canvas.getContext('2d');

            // 1. –ù–ê–°–¢–†–û–ô–ö–ò –õ–ê–ë–ò–†–ò–ù–¢–ê (–£–í–ï–õ–ò–ß–ï–ù–ù–´–ô)
            const cellSize = 20; // –£–º–µ–Ω—å—à–∏–ª —Å 40 –¥–æ 20 (–ª–∞–±–∏—Ä–∏–Ω—Ç —Å—Ç–∞–ª –æ–≥—Ä–æ–º–Ω—ã–º)
            const cols = Math.floor(canvas.width / cellSize);
            const rows = Math.floor(canvas.height / cellSize);
            const grid = [];
            const stack = [];

            class Cell {
                constructor(i, j) {
                    this.i = i; this.j = j;
                    this.walls = [true, true, true, true]; // Top, Right, Bottom, Left
                    this.visited = false;
                }
                
                show() {
                    const x = this.i * cellSize;
                    const y = this.j * cellSize;
                    
                    ctx.strokeStyle = '#00ffff'; 
                    ctx.lineWidth = 1; // –¢–æ–Ω–∫–∏–µ –ª–∏–Ω–∏–∏ –¥–ª—è –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏
                    ctx.shadowBlur = 0; // –£–±—Ä–∞–ª –±–ª—é—Ä –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                    
                    ctx.beginPath();
                    if (this.walls[0]) { ctx.moveTo(x, y); ctx.lineTo(x + cellSize, y); }
                    if (this.walls[1]) { ctx.moveTo(x + cellSize, y); ctx.lineTo(x + cellSize, y + cellSize); }
                    if (this.walls[2]) { ctx.moveTo(x + cellSize, y + cellSize); ctx.lineTo(x, y + cellSize); }
                    if (this.walls[3]) { ctx.moveTo(x, y + cellSize); ctx.lineTo(x, y); }
                    ctx.stroke();
                }
                
                checkNeighbors() {
                    const neighbors = [];
                    const get = (x, y) => {
                        if (x < 0 || y < 0 || x > cols-1 || y > rows-1) return undefined;
                        return grid[x + y * cols];
                    };
                    const top = get(this.i, this.j - 1);
                    const right = get(this.i + 1, this.j);
                    const bottom = get(this.i, this.j + 1);
                    const left = get(this.i - 1, this.j);

                    if (top && !top.visited) neighbors.push(top);
                    if (right && !right.visited) neighbors.push(right);
                    if (bottom && !bottom.visited) neighbors.push(bottom);
                    if (left && !left.visited) neighbors.push(left);
                    
                    if (neighbors.length > 0) return neighbors[Math.floor(Math.random() * neighbors.length)];
                    else return undefined;
                }
            }

            // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É
            for (let j = 0; j < rows; j++) {
                for (let i = 0; i < cols; i++) {
                    grid.push(new Cell(i, j));
                }
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è (DFS)
            let current = grid[0];
            current.visited = true;

            while(true) {
                const next = current.checkNeighbors();
                if (next) {
                    next.visited = true;
                    stack.push(current);
                    const x = current.i - next.i;
                    if (x === 1) { current.walls[3] = false; next.walls[1] = false; }
                    if (x === -1) { current.walls[1] = false; next.walls[3] = false; }
                    const y = current.j - next.j;
                    if (y === 1) { current.walls[0] = false; next.walls[2] = false; }
                    if (y === -1) { current.walls[2] = false; next.walls[0] = false; }
                    current = next;
                } else if (stack.length > 0) {
                    current = stack.pop();
                } else {
                    break; 
                }
            }

            // 2. –î–û–ë–ê–í–õ–ï–ù–ò–ï –§–ï–ô–ö–û–í–´–• –ü–£–¢–ï–ô (–ü–ï–¢–õ–ò)
            // –õ–æ–º–∞–µ–º 5% —Å–ª—É—á–∞–π–Ω—ã—Ö —Å—Ç–µ–Ω, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏ –∏ –∑–∞–ø—É—Ç–∞—Ç—å –∏–≥—Ä–æ–∫–∞
            for (let i = 0; i < cols; i++) {
                for (let j = 0; j < rows; j++) {
                    if (Math.random() > 0.95) { 
                        const cell = grid[i + j * cols];
                        // –õ–æ–º–∞–µ–º —Å—Ç–µ–Ω—É —Å–ø—Ä–∞–≤–∞ –∏–ª–∏ —Å–Ω–∏–∑—É
                        if (Math.random() > 0.5 && i < cols - 1) {
                            cell.walls[1] = false; 
                            grid[(i + 1) + j * cols].walls[3] = false;
                        } else if (j < rows - 1) {
                            cell.walls[2] = false; 
                            grid[i + (j + 1) * cols].walls[0] = false;
                        }
                    }
                }
            }

            let player = { i: 0, j: 0 };
            let goal = { i: cols - 1, j: rows - 1 };
            let scanY = 0;

            function draw() {
                ctx.fillStyle = 'rgba(0,0,0,0.4)'; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–µ–Ω
                for (let i = 0; i < grid.length; i++) { grid[i].show(); }

                // –ò–≥—Ä–æ–∫ (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä)
                const px = player.i * cellSize + cellSize/2;
                const py = player.j * cellSize + cellSize/2;
                
                ctx.beginPath();
                ctx.arc(px, py, cellSize/3, 0, Math.PI*2);
                ctx.fillStyle = '#fff';
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#fff';
                ctx.fill();
                ctx.shadowBlur = 0;
                
                // –§–∏–Ω–∏—à
                const gx = goal.i * cellSize + 2;
                const gy = goal.j * cellSize + 2;
                const pulse = (Math.sin(Date.now() / 150) + 1) * 5;
                
                ctx.fillStyle = '#ff0055';
                ctx.shadowBlur = 10 + pulse;
                ctx.shadowColor = '#ff0055';
                ctx.fillRect(gx, gy, cellSize - 4, cellSize - 4);
                ctx.shadowBlur = 0;

                // –°–∫–∞–Ω-–ª–∏–Ω–∏—è
                scanY += 3;
                if(scanY > canvas.height) scanY = 0;
                
                ctx.fillStyle = 'rgba(0, 255, 255, 0.05)';
                ctx.fillRect(0, scanY, canvas.width, 10);
                
                requestAnimationFrame(draw);
            }

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            window.addEventListener('keydown', (e) => {
                const idx = player.i + player.j * cols;
                const cell = grid[idx];
                
                if ((e.key === 'ArrowUp' || e.key === 'KeyW') && !cell.walls[0]) player.j--;
                if ((e.key === 'ArrowRight' || e.key === 'KeyD') && !cell.walls[1]) player.i++;
                if ((e.key === 'ArrowDown' || e.key === 'KeyS') && !cell.walls[2]) player.j++;
                if ((e.key === 'ArrowLeft' || e.key === 'KeyA') && !cell.walls[3]) player.i--;

                if (player.i === goal.i && player.j === goal.j) {
                    winGame();
                }
            });

            draw();

            // 4. –ü–û–ë–ï–î–ê
            function winGame() {
                document.body.innerHTML = '';
                const winScreen = document.createElement('div');
                winScreen.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: black; display: flex; flex-direction: column;
                    justify-content: center; align-items: center; z-index: 10000;
                `;
                
                winScreen.innerHTML = `
                    <h1 style="font-family: 'Courier New'; font-size: 5rem; color: #33ff33; text-transform: uppercase; animation: winGlitch 0.2s infinite; text-align: center; margin:0;">SYSTEM RESTORED</h1>
                    <p style="color:white; font-family:'Courier New'; font-size: 1.2rem; margin-top:20px;">REMOVING VIRUS...</p>
                    <div style="width: 300px; height: 10px; background: #333; margin-top: 20px; border: 1px solid #33ff33;">
                        <div id="restore-bar" style="width: 0%; height: 100%; background: #33ff33; transition: width 3.5s linear;"></div>
                    </div>
                    <style>
                        @keyframes winGlitch {
                            0% { text-shadow: 2px 2px 0 #ff0000; }
                            50% { text-shadow: -2px -2px 0 #0000ff; }
                            100% { text-shadow: 2px 2px 0 #ff0000; }
                        }
                    </style>
                `;
                
                document.body.appendChild(winScreen);

                setTimeout(() => { document.getElementById('restore-bar').style.width = "100%"; }, 100);
                setTimeout(() => {
                    localStorage.clear(); 
                    location.reload();    
                }, 4000);
            }
        }

// ==========================================
// –ú–ò–ù–ò-–ò–ì–†–ê "NEON WAVE" (OPTIMIZED V2)
// ==========================================
function initWaveGame(id) {
    const canvas = document.getElementById(`waveCanvas-${id}`);
    const menu = document.getElementById(`wave-menu-${id}`);
    const scoreEl = document.getElementById(`score-now-${id}`);
    const bestEl = document.getElementById(`score-best-${id}`);
    
    if (!canvas) return; 

    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    let player = null; 
    let particles = []; 
    
    // --- –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ö–µ—à–∏—Ä—É–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏—Ö –≤ —Ü–∏–∫–ª–µ ---
    let bgGrad = null;
    let wallGrad = null;

    canvas.parentElement.style.cursor = 'none';
    
    function resizeGame() {
        if (!canvas.parentElement) return;
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        if (player) {
            if (player.y > canvas.height) player.y = canvas.height - 20;
        }
        
        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã 1 —Ä–∞–∑ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
        const ctx = canvas.getContext('2d');
        
        bgGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        bgGrad.addColorStop(0, '#050011');
        bgGrad.addColorStop(1, '#1a0033');

        wallGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        wallGrad.addColorStop(0, '#00ffcc');
        wallGrad.addColorStop(0.5, '#0088ff');
        wallGrad.addColorStop(1, '#00ffcc');
    }

    const resizeObserver = new ResizeObserver(() => resizeGame());
    resizeObserver.observe(canvas.parentElement);
    resizeGame(); 
    const ctx = canvas.getContext('2d');

    menu.style.display = 'none';

    let isRunning = true;
    let startTime = Date.now();
    let score = 0;
    let speed = 3; 
    let gravity = 6; 
    let bgOffset = 0; 
    
    player = { x: 80, y: canvas.height / 2, size: 12, goingUp: false };
    let walls = [];
    let wallTimer = 0;
    let gapHeight = 250; 

    const onDown = () => { if(player) player.goingUp = true; };
    const onUp = () => { if(player) player.goingUp = false; };
    
    canvas.onmousedown = onDown;
    canvas.onmouseup = onUp;

// --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –§–ò–ö–°–ê FPS (60 HZ) ---
    let lastFrameTime = 0;
    const fpsLimit = 1000 / 120;

    function loop() {
        if (!isRunning) return;
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã —Ü–∏–∫–ª –Ω–µ –ø—Ä–µ—Ä–≤–∞–ª—Å—è
        requestAnimationFrame(loop);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
        const now = performance.now();
        const elapsed = now - lastFrameTime;
        if (elapsed < fpsLimit) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–¥—Ä, –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ
        lastFrameTime = now - (elapsed % fpsLimit);

        // 1. –§–û–ù (–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
        ctx.fillStyle = bgGrad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –°–µ—Ç–∫–∞
        bgOffset -= speed * 0.5;
        if (bgOffset < -80) bgOffset = 0;
        
        ctx.strokeStyle = 'rgba(255, 0, 255, 0.15)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        
        // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏ —Ä–µ–∂–µ (–∫–∞–∂–¥—ã–µ 80px –≤–º–µ—Å—Ç–æ 40px)
        for (let y = 0; y < canvas.height; y += 80) {
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
        }
        for (let x = bgOffset; x < canvas.width; x += 80) {
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
        }
        ctx.stroke();

        // 2. –õ–û–ì–ò–ö–ê
        let currentTime = Date.now();
        score = (currentTime - startTime) / 1000;
        scoreEl.textContent = score.toFixed(2);

        // --- HARDCORE MODE: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–∞–∑–≥–æ–Ω ---
        // –ü—Ä–æ—Ö–æ–¥ —Å—É–∂–∞–µ—Ç—Å—è –≤ 6 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ (–¥–æ 60px)
        let currentGap = Math.max(60, gapHeight - (score * 2.5));
        
        // –°–∫–æ—Ä–æ—Å—Ç—å —Ä–∞—Å—Ç–µ—Ç –≤ 20 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ (–¥–æ 30)
        let currentSpeed = Math.min(30, speed + (score * 0.4));
        if (player) {
            if (player.goingUp) player.y -= gravity;
            else player.y += gravity;

            if (player.y < 0 || player.y > canvas.height) { gameOver(); return; }
            
            // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –õ–∏–º–∏—Ç —á–∞—Å—Ç–∏—Ü (–º–∞–∫—Å 60)
            if (particles.length < 60) {
                particles.push({
                    x: player.x - 10,
                    y: player.y + (Math.random() - 0.5) * 10,
                    vx: -Math.random() * 4 - 2,
                    vy: (Math.random() - 0.5) * 2,
                    life: 1.0,
                    hue: (score * 10) % 360 // –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç, —Å—Ç—Ä–æ–∫—É –Ω–µ –≥–µ–Ω–µ—Ä–∏–º
                });
            }
        }

        // –°–ø–∞–≤–Ω —Å—Ç–µ–Ω
        wallTimer++;
        if (wallTimer > 600 / currentSpeed) { 
            let minY = 50;
            let maxY = canvas.height - 50 - currentGap;
            let gapY = Math.random() * (maxY - minY) + minY;
            walls.push({ x: canvas.width, w: 30, gapTop: gapY, gapBottom: gapY + currentGap });
            wallTimer = 0;
        }

        // 3. –û–¢–†–ò–°–û–í–ö–ê –ß–ê–°–¢–ò–¶ (–ë–µ–∑ —Ç–µ–Ω–µ–π –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.05;
            
            if (p.life <= 0) {
                particles.splice(i, 1);
            } else {
                ctx.fillStyle = `hsla(${p.hue}, 100%, 50%, ${p.life})`;
                ctx.fillRect(p.x, p.y, 4, 4);
            }
        }

        // 4. –û–¢–†–ò–°–û–í–ö–ê –°–¢–ï–ù (Batch Rendering)
        // –ú—ã –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Å–µ —Å—Ç–µ–Ω—ã –≤ –æ–¥–∏–Ω –ø—É—Ç—å –∏ –∑–∞–ª–∏–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#00ffff';
        ctx.fillStyle = wallGrad; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç

        ctx.beginPath(); 
        for (let i = 0; i < walls.length; i++) {
            let w = walls[i];
            w.x -= currentSpeed;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ –≤ –ø—É—Ç—å
            ctx.rect(w.x, 0, w.w, w.gapTop);
            ctx.rect(w.x, w.gapBottom, w.w, canvas.height - w.gapBottom);

            // –ö–æ–ª–ª–∏–∑–∏—è (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç—É—Ç –∂–µ, —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –ª–∏—à–Ω–∏–π —Ü–∏–∫–ª)
            let hitX = player.x + player.size - 4; 
            if (hitX > w.x && player.x - player.size + 4 < w.x + w.w) {
                if (player.y - player.size + 4 < w.gapTop || player.y + player.size - 4 > w.gapBottom) {
                    gameOver();
                    return;
                }
            }
        }
        ctx.fill(); // –†–ò–°–£–ï–ú –í–°–ï –°–¢–ï–ù–´ –û–î–ù–ò–ú –í–´–ó–û–í–û–ú
        ctx.shadowBlur = 0;
        
        // –£–¥–∞–ª—è–µ–º —É—à–µ–¥—à–∏–µ —Å—Ç–µ–Ω—ã
        if (walls.length > 0 && walls[0].x + walls[0].w < -100) walls.shift();

        // 5. –ò–ì–†–û–ö
        if (player) {
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#ff0055';
            ctx.fillStyle = '#fff';
            
            ctx.beginPath();
            ctx.moveTo(player.x + player.size, player.y);
            ctx.lineTo(player.x - player.size, player.y - player.size + 2);
            ctx.lineTo(player.x - player.size + 5, player.y); 
            ctx.lineTo(player.x - player.size, player.y + player.size - 2);
            ctx.fill();
            
            ctx.strokeStyle = '#ff0055';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
}

    function gameOver() {
        isRunning = false;
        
        let savedBest = parseFloat(localStorage.getItem('feistos_wave_best') || 0);
        if (score > savedBest) {
            localStorage.setItem('feistos_wave_best', score);
            bestEl.textContent = score.toFixed(2);
            bestEl.style.color = '#33ff33';
        }

        menu.style.display = 'flex';
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—É—Ä—Å–æ—Ä
        canvas.parentElement.style.cursor = 'default';

        menu.innerHTML = `
            <h1 style="color: #ff0055; text-transform: uppercase; text-shadow: 0 0 10px red;">SYSTEM FAILURE</h1>
            <p style="color: #fff; font-size: 1.2rem;">Time Alive: ${score.toFixed(2)}s</p>
            <br>
            <button onclick="initWaveGame(${id})" style="padding: 10px 30px; background: #ff0055; color: white; border: none; font-weight: bold; cursor: pointer; font-family: inherit; box-shadow: 0 0 15px #ff0055;">REBOOT SYSTEM</button>
        `;
    }

    requestAnimationFrame(loop);
}

// ==========================================
        // –§–ò–ó–ò–ß–ï–°–ö–ò–ô –î–í–ò–ñ–û–ö (GRAVITY MODE)
        // ==========================================
        let gravityActive = false;
        let physicsObjects = [];
        let physAnimFrame;

        function toggleGravity() {
if (localStorage.getItem('feistos_infected') === 'true') return;
            const btn = document.getElementById('gravity-btn');
            gravityActive = !gravityActive;

            if (gravityActive) {
                // –í–ö–õ–Æ–ß–ï–ù–ò–ï
                btn.style.background = "var(--primary-color)";
                btn.style.color = "black";
                
                // –ë–µ—Ä–µ–º –¢–û–õ–¨–ö–û –∏–∫–æ–Ω–∫–∏ –∏ –æ–∫–Ω–∞ (–ø–∞–Ω–µ–ª—å –∑–∞–¥–∞—á –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
                const elements = [
                    ...document.querySelectorAll('.icon'), 
                    ...document.querySelectorAll('.window')
                ];

                elements.forEach(el => {
                    const rect = el.getBoundingClientRect();
                    
                    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    el.dataset.origLeft = el.style.left;
                    el.dataset.origTop = el.style.top;
                    
                    // –ü–ï–†–ï–ö–õ–Æ–ß–ê–ï–ú –í –†–ï–ñ–ò–ú –§–ò–ó–ò–ö–ò
                    // –î–ª—è –æ–∫–æ–Ω –∏ –∏–∫–æ–Ω–æ–∫ –ø–æ–¥—Ö–æ–¥–∏—Ç fixed, —á—Ç–æ–±—ã –æ—Ç–≤—è–∑–∞—Ç—å—Å—è –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
                    el.style.position = 'fixed';
                    el.style.left = rect.left + 'px';
                    el.style.top = rect.top + 'px';
                    el.style.margin = '0';
                    el.style.width = rect.width + 'px';
                    el.style.height = rect.height + 'px';
                    el.style.zIndex = '9999'; 
                    
                    physicsObjects.push({
                        el: el,
                        x: rect.left,
                        y: rect.top,
                        w: rect.width,
                        h: rect.height,
                        vx: (Math.random() - 0.5) * 10, // –õ–µ–≥–∫–∏–π —Ç–æ–ª—á–æ–∫
                        vy: (Math.random() - 0.5) * 10,
                        isDragging: false
                    });

                    // –•–≤–∞—Ç–∞–Ω–∏–µ –º—ã—à–∫–æ–π
                    el.onmousedown = (e) => startPhysDrag(e, el);
                });

                physicsLoop();

            } else {
                // –í–´–ö–õ–Æ–ß–ï–ù–ò–ï
                btn.style.background = "rgba(255,255,255,0.1)";
                btn.style.color = "white";
                cancelAnimationFrame(physAnimFrame);

                physicsObjects.forEach(obj => {
                    const el = obj.el;
                    
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å—ë –∫–∞–∫ –±—ã–ª–æ (absolute –¥–ª—è —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞)
                    el.style.position = 'absolute'; 
                    el.style.left = el.dataset.origLeft;
                    el.style.top = el.dataset.origTop;
                    el.style.margin = '';
                    el.style.width = '';  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∂–µ—Å—Ç–∫–∏–µ —Ä–∞–∑–º–µ—Ä—ã
                    el.style.height = '';
                    el.style.zIndex = '';
                    
                    // –£–±–∏—Ä–∞–µ–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∑–∞—Ö–≤–∞—Ç
                    el.onmousedown = null;
                });
                
                physicsObjects = [];
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–ª–∏–∫–∏
                document.querySelectorAll('.icon').forEach(icon => {
                   icon.addEventListener('mousedown', (e) => onIconMouseDown(e, icon));
                });
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –æ–∫–æ–Ω –∑–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
                document.querySelectorAll('.window').forEach(win => {
                    const header = win.querySelector('.window-header');
                    if(header) header.onmousedown = (e) => dragWindow(e, win);
                });
            }
        }

        function startPhysDrag(e, el) {
            if (!gravityActive) return;
            e.preventDefault();
            e.stopPropagation(); 

            const obj = physicsObjects.find(o => o.el === el);
            if (!obj) return;

            obj.isDragging = true;
            let lastX = e.clientX;
            let lastY = e.clientY;

            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ê–ì–ê –° –¢–ï–õ–ï–ü–û–†–¢–ê–¶–ò–ï–ô ---
            // –í—ã—á–∏—Å–ª—è–µ–º, –∑–∞ –∫–∞–∫—É—é –∏–º–µ–Ω–Ω–æ —Ç–æ—á–∫—É –≤–Ω—É—Ç—Ä–∏ –æ–∫–Ω–∞ –º—ã —Å—Ö–≤–∞—Ç–∏–ª–∏—Å—å.
            // Offset = –ü–æ–∑–∏—Ü–∏—è –º—ã—à–∏ - –ü–æ–∑–∏—Ü–∏—è –æ–∫–Ω–∞
            let mouseOffsetX = e.clientX - obj.x;
            let mouseOffsetY = e.clientY - obj.y;
            // ----------------------------------------

            function onMove(ev) {
                // –†–∞—Å—á–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–ª—è –±—Ä–æ—Å–∫–∞
                obj.vx = (ev.clientX - lastX) * 1.5; 
                obj.vy = (ev.clientY - lastY) * 1.5;
                lastX = ev.clientX;
                lastY = ev.clientY;
                
                // –î–í–ò–ì–ê–ï–ú –° –£–ß–ï–¢–û–ú –°–ú–ï–©–ï–ù–ò–Ø
                // –¢–µ–ø–µ—Ä—å –æ–∫–Ω–æ –±—É–¥–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è —Ä–æ–≤–Ω–æ –∑–∞ —Ç—É —Ç–æ—á–∫—É, –≥–¥–µ —Ç—ã –µ–≥–æ –≤–∑—è–ª
                obj.x = ev.clientX - mouseOffsetX;
                obj.y = ev.clientY - mouseOffsetY;
            }

            function onUp() {
                obj.isDragging = false;
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            }

            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        }

        function physicsLoop() {
            if (!gravityActive) return;

            const GRAVITY = 0.8;
            const FRICTION = 0.98; // –°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –≤–æ–∑–¥—É—Ö–∞
            const BOUNCE = 0.7;    // –£–ø—Ä—É–≥–æ—Å—Ç—å (0.9 - –∫–∞–∫ –º—è—á–∏–∫, 0.5 - –∫–∞–∫ –∫–∏—Ä–ø–∏—á)
            
            // –ì—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞ (—É—á–∏—Ç—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∑–∞–¥–∞—á —Å–Ω–∏–∑—É ~45px)
            const floor = window.innerHeight - 50; 
            const wallRight = window.innerWidth;

            physicsObjects.forEach(obj => {
                if (obj.isDragging) {
                    // –ü–æ–∫–∞ —Ç–∞—â–∏–º, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ CSS
                    obj.el.style.left = obj.x + 'px';
                    obj.el.style.top = obj.y + 'px';
                    return;
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–∑–∏–∫—É
                obj.vy += GRAVITY;
                obj.vx *= FRICTION;
                obj.vy *= FRICTION;

                obj.x += obj.vx;
                obj.y += obj.vy;

                // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –ü–û–õ–û–ú
                if (obj.y + obj.h > floor) {
                    obj.y = floor - obj.h;
                    obj.vy *= -BOUNCE;
                    // –ï—Å–ª–∏ —Å–∫–æ—Ä–æ—Å—Ç—å –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∞—è, –æ–±–Ω—É–ª—è–µ–º (—á—Ç–æ–±—ã –Ω–µ –¥—Ä–æ–∂–∞–ª–æ)
                    if (Math.abs(obj.vy) < GRAVITY * 2) obj.vy = 0;
                }
                // –ü–û–¢–û–õ–û–ö
                else if (obj.y < 0) {
                    obj.y = 0;
                    obj.vy *= -BOUNCE;
                }

                // –°–¢–ï–ù–´
                if (obj.x + obj.w > wallRight) {
                    obj.x = wallRight - obj.w;
                    obj.vx *= -BOUNCE;
                } else if (obj.x < 0) {
                    obj.x = 0;
                    obj.vx *= -BOUNCE;
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                obj.el.style.left = obj.x + 'px';
                obj.el.style.top = obj.y + 'px';
            });

            physAnimFrame = requestAnimationFrame(physicsLoop);
        }

// ==========================================
// –†–ï–ñ–ò–ú –†–ò–°–û–í–ê–ù–ò–Ø (GRAFFITI MODE) - FINAL V3
// ==========================================
let paintActive = false;
const pCanvas = document.getElementById('graffiti-layer');
const pCtx = pCanvas.getContext('2d');
let isPainting = false;
let isErasing = false;
let hue = 0; 
let lastRightClickTime = 0; // –î–ª—è –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
function resizePaint() {
    pCanvas.width = window.innerWidth;
    pCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resizePaint);
resizePaint();

function togglePaint() {
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –≤–∏—Ä—É—Å–∞
    if (localStorage.getItem('feistos_infected') === 'true') return;

    const btn = document.getElementById('paint-btn');
    paintActive = !paintActive;

    if (paintActive) {
        btn.style.background = "var(--primary-color)";
        btn.style.color = "black";
        document.body.style.cursor = 'crosshair';
    } else {
        btn.style.background = "rgba(255,255,255,0.1)";
        btn.style.color = "white";
        document.body.style.cursor = 'default';
        isPainting = false;
        isErasing = false;
    }
}

// –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ú–´–®–ò
document.addEventListener('mousedown', (e) => {
    // 1. –õ–û–ì–ò–ö–ê –í –†–ï–ñ–ò–ú–ï –†–ò–°–û–í–ê–ù–ò–Ø
    if (paintActive) {
        // –õ–ö–ú: –†–ò–°–û–í–ê–ù–ò–ï (–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –Ω–∞–∂–∞—Ç –ø—Ä–æ–±–µ–ª)
        if (e.button === 0) {
            if (isSpacePressed) return; // –ï—Å–ª–∏ –ø—Ä–æ–±–µ–ª –Ω–∞–∂–∞—Ç, –¥–∞–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å–∏—Å—Ç–µ–º–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
            
            isPainting = true;
            isErasing = false;
            pCtx.globalCompositeOperation = 'source-over'; // –†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            pCtx.beginPath();
            pCtx.moveTo(e.clientX, e.clientY);
        }
        
        // –ü–ö–ú: –õ–ê–°–¢–ò–ö –ò–õ–ò –û–ß–ò–°–¢–ö–ê
        if (e.button === 2) {
            const now = Date.now();
            // –î–í–û–ô–ù–û–ô –ö–õ–ò–ö (–∏–Ω—Ç–µ—Ä–≤–∞–ª < 300–º—Å)
            if (now - lastRightClickTime < 300) {
                pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
                if(typeof SoundEngine !== 'undefined') SoundEngine.sfx.error();
            } else {
                // –û–ë–´–ß–ù–û–ï –ù–ê–ñ–ê–¢–ò–ï -> –õ–ê–°–¢–ò–ö
                isErasing = true;
                isPainting = false;
                pCtx.beginPath();
                pCtx.moveTo(e.clientX, e.clientY);
            }
            lastRightClickTime = now;
        }
    }
});

document.addEventListener('mouseup', () => {
    isPainting = false;
    isErasing = false;
    pCtx.beginPath();
});

document.addEventListener('mousemove', (e) => {
    if (!paintActive) return;

    // –†–ò–°–û–í–ê–ù–ò–ï
    if (isPainting) {
        pCtx.globalCompositeOperation = 'source-over';
        pCtx.lineWidth = 4;
        pCtx.lineCap = 'round';
        pCtx.lineJoin = 'round';
        pCtx.strokeStyle = `hsl(${hue}, 100%, 50%)`;
        pCtx.shadowBlur = 10;
        pCtx.shadowColor = `hsl(${hue}, 100%, 50%)`;
        
        pCtx.lineTo(e.clientX, e.clientY);
        pCtx.stroke();
        
        hue += 2; 
        if (hue >= 360) hue = 0;
        
        pCtx.beginPath();
        pCtx.moveTo(e.clientX, e.clientY);
    }
    
    // –õ–ê–°–¢–ò–ö
    if (isErasing) {
        pCtx.globalCompositeOperation = 'destination-out'; // –†–µ–∂–∏–º —Å—Ç–∏—Ä–∞–Ω–∏—è
        pCtx.lineWidth = 20; // –õ–∞—Å—Ç–∏–∫ –ø–æ—Ç–æ–ª—â–µ
        pCtx.lineCap = 'round';
        pCtx.lineJoin = 'round';
        pCtx.shadowBlur = 0; // –ë–µ–∑ —Ç–µ–Ω–∏
        
        pCtx.lineTo(e.clientX, e.clientY);
        pCtx.stroke();
        
        pCtx.beginPath();
        pCtx.moveTo(e.clientX, e.clientY);
    }
});

// –ë–õ–û–ö–ò–†–û–í–ö–ê –ö–û–ù–¢–ï–ö–°–¢–ù–û–ì–û –ú–ï–ù–Æ –ò –£–î–ê–õ–ï–ù–ò–ï –í–ù–ï –†–ï–ñ–ò–ú–ê
document.addEventListener('contextmenu', (e) => {
    // –ï—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è -> –≤—Å–µ–≥–¥–∞ –±–ª–æ–∫–∏—Ä—É–µ–º –º–µ–Ω—é (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª –ª–∞—Å—Ç–∏–∫)
    if (paintActive) {
        e.preventDefault();
        return false;
    }

    // –ï—Å–ª–∏ –º—ã –ù–ï –≤ —Ä–µ–∂–∏–º–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è -> –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –ø–æ —Ä–∏—Å—É–Ω–∫—É
    const pixel = pCtx.getImageData(e.clientX, e.clientY, 1, 1).data;
    if (pixel[3] > 0) { // –ï—Å–ª–∏ –ø–∏–∫—Å–µ–ª—å –Ω–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π
        e.preventDefault();
        e.stopPropagation();
        
        // –û—á–∏—â–∞–µ–º –≤—Å—ë
        pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
        
        if(typeof SoundEngine !== 'undefined') SoundEngine.sfx.error(); 
        const ctxMenu = document.getElementById('custom-context-menu');
        if(ctxMenu) ctxMenu.style.display = 'none';
        
        return false;
    }
});

function placeBet(winId, carIndex) {
    const root = document.getElementById(`race-root-${winId}`);
    if(!root) return;
    
    // –†–∞–±–æ—Ç–∞ —Å –¥–µ–Ω—å–≥–∞–º–∏
    let money = parseInt(localStorage.getItem('feistos_money') || "1000");
    if (money < 100) {
        alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤! –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ –ø–æ—Å–æ–±–∏–µ –ø–æ –±–µ–¥–Ω–æ—Å—Ç–∏: $500.");
        money = 500;
        localStorage.setItem('feistos_money', money);
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –æ–∫–Ω–∞
        root.closest('.window').querySelector('.btn-close').click();
        openWindow('cyber_bet', 'Cyber Bet');
        return;
    }

    localStorage.setItem('feistos_money', money - 100); // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É
    
    // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –∑–∞–ø—É—Å–∫–∞–µ–º –≥–æ–Ω–∫—É
    document.getElementById(`bet-screen-${winId}`).style.display = 'none';
    document.getElementById(`race-ui-${winId}`).style.display = 'block';
    
    initRacingGame(winId, carIndex);
}

function startPlayerRace(winId, playerCarIndex) {
    const root = document.getElementById(`race-root-${winId}`);
    if(!root) return;
    
    let money = parseInt(localStorage.getItem('feistos_money') || "1000");
    if (money < 100) {
        alert("Not enough cash! You need $100 for entry fee.");
        return;
    }

    localStorage.setItem('feistos_money', money - 100);
    
    document.getElementById(`bet-screen-${winId}`).style.display = 'none';
    document.getElementById(`race-ui-${winId}`).style.display = 'block';
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–≤–∏–∂–æ–∫ –≤ —Ä–µ–∂–∏–º–µ –ò–ì–†–û–ö–ê
    initRacingGame(winId, playerCarIndex, true);
}

function initRacingGame(winId, playerIndex, isHumanPlaying = false) {
    const canvas = document.getElementById(`race-canvas-${winId}`);
    if (!canvas) return;
    
    const container = canvas.parentElement;
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
    const ctx = canvas.getContext('2d');

    // --- 1. –¢–†–ê–°–°–ê (–°–õ–û–ñ–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø "SNAKE") ---
    const trackPoints = [];
    const mapWidth = 8000;  // –ß—É—Ç—å —à–∏—Ä–µ –∫–∞—Ä—Ç–∞
    const mapHeight = 6000; 
    const trackWidth = 280; 

    // –£–º–µ–Ω—å—à–∞–µ–º —à–∞–≥ (0.01) –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω—ã—Ö, –Ω–æ —Ä–µ–∑–∫–∏—Ö –ø–æ–≤–æ—Ä–æ—Ç–æ–≤
    for (let i = 0; i < 6.28; i += 0.01) {
        // –ë–∞–∑–æ–≤–∞—è —Ñ–æ—Ä–º–∞
        let x = (mapWidth/2) + Math.cos(i) * 2400;
        let y = (mapHeight/2) + Math.sin(i) * 1800;

        // –°–õ–û–ñ–ù–û–°–¢–¨: –î–æ–±–∞–≤–ª—è–µ–º –≥–ª—É–±–æ–∫–∏–µ "–∫–∞—Ä–º–∞–Ω—ã"
        // i * 7 = 7 —Ä–µ–∑–∫–∏—Ö –ø–µ—Ç–µ–ª—å –ø–æ –∫—Ä—É–≥—É
        // * 1100 = –ì–ª—É–±–∏–Ω–∞ –ø–æ–≤–æ—Ä–æ—Ç–∞ (–æ—á–µ–Ω—å –≥–ª—É–±–æ–∫–∞—è, —Å—Ä–µ–∑–∞—Ç—å –¥–æ–ª–≥–æ)
        x += Math.cos(i * 7) * 1100; 
        y += Math.sin(i * 5) * 900;

        // –¢–ï–•–ù–ò–ß–ù–û–°–¢–¨: –î–æ–±–∞–≤–ª—è–µ–º –º–µ–ª–∫–∏–µ —à–∏–∫–∞–Ω—ã (–∑–∏–≥-–∑–∞–≥–∏)
        x += Math.sin(i * 20) * 150;
        y += Math.cos(i * 20) * 150;

        trackPoints.push({x, y});
    }

    // --- 2. –ú–ê–®–ò–ù–´ ---
    const cars = [
        { id: 0, color: '#ff0055', name: 'RED',  speed:0, angle:0, maxSpeed: 11, acc: 0.15, turn: 0.06, weight: 1.2, aggro: 0.9, laneOffset: -40 }, 
        { id: 1, color: '#33ff33', name: 'GRN',  speed:0, angle:0, maxSpeed: 10.5, acc: 0.14, turn: 0.07, weight: 1.0, aggro: 0.2, laneOffset: 40 }, 
        { id: 2, color: '#00ccff', name: 'BLU',  speed:0, angle:0, maxSpeed: 12, acc: 0.13, turn: 0.05, weight: 0.8, aggro: 0.0, laneOffset: 0 }, 
        { id: 3, color: '#ffff00', name: 'YLW',  speed:0, angle:0, maxSpeed: 11.3, acc: 0.15, turn: 0.06, weight: 1.8, aggro: 0.8, laneOffset: -80 },
        { id: 4, color: '#9b59b6', name: 'PUR',  speed:0, angle:0, maxSpeed: 11.3, acc: 0.15, turn: 0.055, weight: 0.9, aggro: 0.1, laneOffset: 80 },
        { id: 5, color: '#e67e22', name: 'ORG',  speed:0, angle:0, maxSpeed: 11.4, acc: 0.15, turn: 0.06, weight: 1.3, aggro: 1.0, laneOffset: -100 },
        { id: 6, color: '#ecf0f1', name: 'WHT',  speed:0, angle:0, maxSpeed: 11.5, acc: 0.18, turn: 0.05, weight: 0.7, aggro: 0.0, laneOffset: 100 },
        { id: 7, color: '#ff00ff', name: 'PNK',  speed:0, angle:0, maxSpeed: 11.2, acc: 0.15, turn: 0.06, weight: 1.0, aggro: 0.4, laneOffset: 20 }
    ];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π
    cars.forEach((car, i) => {
        // --- FIX: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ —Å—Ç–∞—Ä—Ç–∞ –∏ —É–≥–ª–∞ ---
        // –ë–µ—Ä–µ–º –≤–µ–∫—Ç–æ—Ä —Å—Ç–∞—Ä—Ç–∞ (–æ—Ç 0-–π –¥–æ 5-–π —Ç–æ—á–∫–∏ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏)
        let p0 = trackPoints[0];
        let p1 = trackPoints[5];
        let dx = p1.x - p0.x;
        let dy = p1.y - p0.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        
        // –ù–æ—Ä–º–∞–ª—å (–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä) –¥–ª—è —Å–º–µ—â–µ–Ω–∏—è –ø–æ –ø–æ–ª–æ—Å–∞–º
        let nx = -dy / dist;
        let ny = dx / dist;

        // –°—Ç–∞–≤–∏–º –º–∞—à–∏–Ω—É —Ä–æ–≤–Ω–æ –≤ –µ—ë –ø–æ–ª–æ—Å—É (laneOffset)
        // –ò –Ω–µ–º–Ω–æ–≥–æ —Å–º–µ—â–∞–µ–º –Ω–∞–∑–∞–¥ –ø–æ —Ä—è–¥–∞–º (i * 20), —á—Ç–æ–±—ã –Ω–µ —Å—Ç–æ—è–ª–∏ –≤ –∫—É—á–µ
        car.x = p0.x + (nx * car.laneOffset) - (dx/dist * i * 30);
        car.y = p0.y + (ny * car.laneOffset) - (dy/dist * i * 30);
        
        // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –º–∞—à–∏–Ω—É –Ω–æ—Å–æ–º –ø–æ —Ç—Ä–∞—Å—Å–µ
        car.angle = Math.atan2(dy, dx);

        car.targetIndex = 6; 
        car.lap = 0;
        car.finished = false;
        car.stuckTimer = 0;
        
        if (isHumanPlaying && car.id === playerIndex) {
            car.maxSpeed = 11.1; 
            car.acc = 0.5;       
            car.friction = 0.96;
            car.drift = 0;
        }
    });

    let camera = { x: 0, y: 0, zoom: 0.5 };
// --- COUNTDOWN VARIABLES ---
    let raceCountdown = 3;
    let raceStarted = false;
    let countTimer = setInterval(() => {
        raceCountdown--;
        if(raceCountdown < 0) {
            raceStarted = true;
            clearInterval(countTimer);
        }
    }, 1000);
    const totalLaps = 2;
    let raceOver = false;
    let winner = null;
    
    // –í–≤–æ–¥ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    const keys = { w:false, a:false, s:false, d:false, up:false, left:false, down:false, right:false, ctrl:false };
    const handleKey = (e, state) => {
        const k = e.key.toLowerCase();
        
        // –ê–Ω–≥–ª–∏–π—Å–∫–∞—è (WASD) + –†—É—Å—Å–∫–∞—è (–¶–§–´–í) —Ä–∞—Å–∫–ª–∞–¥–∫–∏
        if(k==='w' || k==='—Ü') keys.w = state; 
        if(k==='a' || k==='—Ñ') keys.a = state; 
        if(k==='s' || k==='—ã') keys.s = state; 
        if(k==='d' || k==='–≤') keys.d = state;

        if(e.key==='ArrowUp') keys.up = state; 
        if(e.key==='ArrowLeft') keys.left = state;
        if(e.key==='ArrowDown') keys.down = state; 
        if(e.key==='ArrowRight') keys.right = state;
        if(e.key==='Control') keys.ctrl = state;
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞ –æ–∫–Ω–æ (—É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –µ—Å–ª–∏ –±—ã–ª–∏, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –ø–∞–º—è—Ç–∏, –Ω–æ —Ç—É—Ç –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º)
    // –õ—É—á—à–µ –¥–µ–ª–∞—Ç—å —ç—Ç–æ –æ–¥–∏–Ω —Ä–∞–∑, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤—Å—Ç–∞–≤–∏–º —Å—é–¥–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ñ–æ–∫—É—Å–∞
    canvas.tabIndex = 1; // –î–µ–ª–∞–µ–º –∫–∞–Ω–≤–∞—Å —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—ã–º
    canvas.focus();
    canvas.addEventListener('keydown', (e) => { e.preventDefault(); handleKey(e, true); });
    canvas.addEventListener('keyup', (e) => { e.preventDefault(); handleKey(e, false); });
    canvas.addEventListener('wheel', (e) => {
        e.preventDefault(); camera.zoom += e.deltaY * -0.0005;
        if(camera.zoom < 0.2) camera.zoom = 0.2; if(camera.zoom > 1.2) camera.zoom = 1.2;
    });

// --- –ü–û–î-–§–£–ù–ö–¶–ò–Ø: –î–†–ò–§–¢ ---
function handleDrift(car) {
    if (keys.ctrl && Math.abs(car.speed) > 4) {
        car.isDrifting = true;
        car.turn = 0.12;      // –†–µ–∑–∫–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä—É–ª—è
        car.friction = 0.99;  // –ú–∞—à–∏–Ω–∞ –¥–æ–ª—å—à–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–Ω–µ—Ä—Ü–∏—é –≤ –∑–∞–Ω–æ—Å–µ
        car.speed *= 0.98;    // –ù–æ –Ω–µ–º–Ω–æ–≥–æ —Ç–µ—Ä—è–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑-–∑–∞ —Ç—Ä–µ–Ω–∏—è –±–æ–∫–æ–º
    } else {
        car.isDrifting = false;
        car.turn = 0.06;      // –í–æ–∑–≤—Ä–∞—Ç –∫ –æ–±—ã—á–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
        car.friction = 0.96;
    }
}

    // ==========================================
    // –ü–û–î-–§–£–ù–ö–¶–ò–Ø 1: –§–ò–ó–ò–ö–ê –ò–ì–†–û–ö–ê
    // ==========================================
    function updatePlayerPhysics(car) {
        // –£—Å–∫–æ—Ä–µ–Ω–∏–µ
        if (keys.w || keys.up) car.speed += car.acc;
        if (keys.s || keys.down) car.speed -= car.acc * 0.8;
        
        // –¢—Ä–µ–Ω–∏–µ –∏ –º–∞–∫—Å —Å–∫–æ—Ä–æ—Å—Ç—å
        car.speed *= car.friction;
        if (car.speed > car.maxSpeed) car.speed = car.maxSpeed;
        if (car.speed < -4) car.speed = -4; // –ó–∞–¥–Ω–∏–π —Ö–æ–¥

        // –ü–æ–≤–æ—Ä–æ—Ç (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å)
        if (Math.abs(car.speed) > 0.1) {
            const dir = car.speed > 0 ? 1 : -1;
            if (keys.a || keys.left) car.angle -= car.turn * dir;
            if (keys.d || keys.right) car.angle += car.turn * dir;
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–µ–∫—Ç–æ—Ä
        car.vx = Math.cos(car.angle) * car.speed;
        car.vy = Math.sin(car.angle) * car.speed;
        car.x += car.vx;
        car.y += car.vy;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ–∫–ø–æ–∏–Ω—Ç–æ–≤ (—á—Ç–æ–±—ã —Å—á–∏—Ç–∞—Ç—å –∫—Ä—É–≥–∏)
        checkWaypoints(car);
    }

    // ==========================================
    // –ü–û–î-–§–£–ù–ö–¶–ò–Ø 2: –ê–ì–†–ï–°–°–ò–í–ù–´–ô –ò–ò (HUMAN ERROR UPDATE)
    // ==========================================
    function updateAggressiveAI(car, playerCar) {
        // --- –õ–û–ì–ò–ö–ê –û–®–ò–ë–û–ö (50% –®–ê–ù–°) ---
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞–º—è—Ç–∏ –¥–ª—è –±–æ—Ç–∞, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        if (typeof car.lastTargetIndex === 'undefined') {
            car.lastTargetIndex = car.targetIndex;
            car.isSmartTurn = Math.random() < 0.5; // –ù–∞—á–∞–ª—å–Ω—ã–π —à–∞–Ω—Å
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –ø—Ä–æ–µ—Ö–∞–ª –ª–∏ –±–æ—Ç –æ—á–µ—Ä–µ–¥–Ω–æ–π —á–µ–∫–ø–æ–∏–Ω—Ç?
        if (car.targetIndex !== car.lastTargetIndex) {
            // –ù–æ–≤—ã–π —É—á–∞—Å—Ç–æ–∫ —Ç—Ä–∞—Å—Å—ã -> –ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–¥–∞—á–∏
            // 50% —à–∞–Ω—Å –≤–∫–ª—é—á–∏—Ç—å "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º", 50% —à–∞–Ω—Å "–∑–∞—Ç—É–ø–∏—Ç—å"
            car.isSmartTurn = Math.random() < 0.5; 
            car.lastTargetIndex = car.targetIndex;
        }

        // 1. –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –ü–û–ò–°–ö –ü–£–¢–ò
        // –ï—Å–ª–∏ –ø–æ–≤–µ–∑–ª–æ (isSmartTurn): lookAhead = 18 (–°—Ä–µ–∑–∞–µ—Ç —É–≥–ª—ã, –ø—Ä–æ—Ñ–∏)
        // –ï—Å–ª–∏ –Ω–µ –ø–æ–≤–µ–∑–ª–æ: lookAhead = 4 (–ï–¥–µ—Ç –∫–∞–∫ –Ω–æ–≤–∏—á–æ–∫, –ø–æ–∑–¥–Ω–æ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç)
        let lookAhead = car.isSmartTurn ? 18 : 4; 
        
        let pCurrent = trackPoints[car.targetIndex];
        let pNext = trackPoints[(car.targetIndex + lookAhead) % trackPoints.length];
        
        let dx = pNext.x - pCurrent.x;
        let dy = pNext.y - pCurrent.y;
        let len = Math.sqrt(dx*dx + dy*dy);
        let nx = -dy / len; 
        let ny = dx / len;  

        // 2. –ñ–ï–°–¢–ö–ò–ï –ì–†–ê–ù–ò–¶–´
        if (car.laneOffset > 110) car.laneOffset = 110;
        if (car.laneOffset < -110) car.laneOffset = -110;

        let targetX = pCurrent.x + (nx * car.laneOffset);
        let targetY = pCurrent.y + (ny * car.laneOffset);

        // 3. –ê–¢–ê–ö–ê –ò–ì–†–û–ö–ê (–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–æ—Ç –≤ "—É–º–Ω–æ–º" —Ä–µ–∂–∏–º–µ)
        if (isHumanPlaying && !car.finished && car.isSmartTurn) {
            const distToPlayer = Math.sqrt((car.x - playerCar.x)**2 + (car.y - playerCar.y)**2);
            
            if (distToPlayer < 500) {
                if (car.aggro > 0.3) {
                    targetX = (targetX * 0.8) + (playerCar.x * 0.2); 
                    targetY = (targetY * 0.8) + (playerCar.y * 0.2);
                }
            }
        }

        // 4. –§–ò–ó–ò–ö–ê
        let desiredAngle = Math.atan2(targetY - car.y, targetX - car.x);
        let diff = desiredAngle - car.angle;
        
        while (diff < -Math.PI) diff += Math.PI * 2;
        while (diff > Math.PI) diff -= Math.PI * 2;
        
        car.angle += diff * car.turn;
        
        if (car.speed < car.maxSpeed) car.speed += car.acc;
        
        // –ï—Å–ª–∏ –±–æ—Ç "—Ç—É–ø–∏—Ç" (–∫–æ—Ä–æ—Ç–∫–∏–π lookAhead), –æ–Ω –≤—Ö–æ–¥–∏—Ç –≤ –ø–æ–≤–æ—Ä–æ—Ç —Ä–µ–∑—á–µ, 
        // –ø–æ—ç—Ç–æ–º—É –µ–º—É –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è —Å–∏–ª—å–Ω–µ–µ —Ç–æ—Ä–º–æ–∑–∏—Ç—å
        if (Math.abs(diff) > 0.4) car.speed *= 0.96; 

        car.vx = Math.cos(car.angle) * car.speed;
        car.vy = Math.sin(car.angle) * car.speed;
        car.x += car.vx;
        car.y += car.vy;

        // 5. –ê–ù–¢–ò-–ó–ê–°–¢–†–ï–í–ê–ù–ò–ï
        let dist = Math.sqrt((car.x - targetX)**2 + (car.y - targetY)**2);
        if (car.speed < 2 && ++car.stuckTimer > 30) {
            car.laneOffset = 0; 
            car.stuckTimer = 0;
        }

        checkWaypoints(car);
    }

    // ==========================================
    // –ü–û–î-–§–£–ù–ö–¶–ò–Ø 3: –ß–ï–ö–ü–û–ò–ù–¢–´ –ò –ö–†–£–ì–ò
    // ==========================================
    function checkWaypoints(car) {
        let target = trackPoints[car.targetIndex];
        let dist = Math.sqrt((car.x - target.x)**2 + (car.y - target.y)**2);
        
        // –î–ª—è –∏–≥—Ä–æ–∫–∞ —Ä–∞–¥–∏—É—Å –±–æ–ª—å—à–µ, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –º–æ–∂–µ—Ç –µ—Ö–∞—Ç—å –∫—Ä–∏–≤–æ
        const captureRadius = (isHumanPlaying && car.id === playerIndex) ? 500 : 350;

        if (dist < captureRadius) {
            car.targetIndex++;
            if (car.targetIndex >= trackPoints.length) {
                car.targetIndex = 0;
                car.lap++;
                if (car.lap >= totalLaps) {
                    car.finished = true;
                    if (!winner) winner = car;
                }
            }
        }
    }

    // ==========================================
    // –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –û–ë–ù–û–í–õ–ï–ù–ò–Ø
    // ==========================================
    let lastFrameTime = 0;
    const fpsLimit = 1000 / 120; // –†–æ–≤–Ω–æ 60 –∫–∞–¥—Ä–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É

    function update() {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–≥—Ä—ã
        const now = performance.now();
        const elapsed = now - lastFrameTime;
        if (!document.getElementById(`race-canvas-${winId}`)) return;

        const playerCar = cars[playerIndex];

        cars.forEach(car => {
if (elapsed < fpsLimit) return;
        
        // –§–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–∞–¥—Ä–∞
        lastFrameTime = now - (elapsed % fpsLimit);

        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ —Å—Ç–∞—Ä—Ç–∞
        if (!raceStarted) return;
            if (car.finished) return;

            if (isHumanPlaying && car.id === playerIndex) {
                updatePlayerPhysics(car);
            } else {
                updateAggressiveAI(car, playerCar);
            }

            // –ö–æ–ª–ª–∏–∑–∏–∏ –º–µ–∂–¥—É –í–°–ï–ú–ò –º–∞—à–∏–Ω–∞–º–∏
            cars.forEach(other => {
                if (car !== other && !other.finished) {
                    let dx = car.x - other.x;
                    let dy = car.y - other.y;
                    let d = Math.sqrt(dx*dx + dy*dy);
                    
                    if (d < 40) { // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ
                        let angle = Math.atan2(dy, dx);
                        let force = 2.0 * (car.weight / other.weight); // –¢—è–∂–µ–ª—ã–π —Ç–æ–ª–∫–∞–µ—Ç —Å–∏–ª—å–Ω–µ–µ
                        
                        car.x += Math.cos(angle) * force;
                        car.y += Math.sin(angle) * force;
                        
                        // –ü–µ—Ä–µ–¥–∞—á–∞ –∏–º–ø—É–ª—å—Å–∞
                        car.speed *= 0.85; 
                        
                        // –ï—Å–ª–∏ —ç—Ç–æ –±–æ—Ç, –æ–Ω "–±–µ—Å–∏—Ç—Å—è" –æ—Ç —É–¥–∞—Ä–∞ –∏ –º–µ–Ω—è–µ—Ç –ø–æ–ª–æ—Å—É
                        if (car.id !== playerIndex) car.laneOffset += (Math.random() > 0.5 ? 30 : -30);
                    }
                }
            });
        });

        // –ö–∞–º–µ—Ä–∞ –∏ UI
        let camTarget = cars[playerIndex];
        
        // –ü–ª–∞–≤–Ω–æ–µ —Å–ª–µ–∂–µ–Ω–∏–µ
        let tx = camTarget.x - canvas.width / (2 * camera.zoom);
        let ty = camTarget.y - canvas.height / (2 * camera.zoom);
        camera.x += (tx - camera.x) * 0.1;
        camera.y += (ty - camera.y) * 0.1;

        // UI
        const lapEl = document.getElementById(`lap-counter-${winId}`);
        const speedEl = document.getElementById(`speed-meter-${winId}`);
        const posEl = document.getElementById(`pos-meter-${winId}`);
        const statusEl = document.getElementById(`bet-status-${winId}`);
        
        if (lapEl) {
            let curLap = Math.min(cars[playerIndex].lap + 1, totalLaps);
            if (cars[playerIndex].finished) curLap = "FINISH";
            lapEl.innerText = `${curLap}/${totalLaps}`;
            
            // –°–ø–∏–¥–æ–º–µ—Ç—Ä
            let speedKmh = Math.round(cars[playerIndex].speed * 20);
            if(speedKmh < 0) speedKmh = 0;
            speedEl.innerText = speedKmh + " KM/H";
            
            // –ü–æ–∑–∏—Ü–∏—è
            let sorted = [...cars].sort((a,b) => (b.lap * 10000 + b.targetIndex) - (a.lap * 10000 + a.targetIndex));
            let pos = sorted.findIndex(c => c.id === playerIndex) + 1;
            posEl.innerText = `POS: ${pos}/8`;

            if (winner) {
                if (winner.id === playerIndex) {
                    statusEl.textContent = "VICTORY!"; 
                    statusEl.style.color = "#00ff00";
                } else {
                    statusEl.textContent = "WASTED"; 
                    statusEl.style.color = "#ff0000";
                }
                if (!raceOver) {
                    raceOver = true;
                    setTimeout(() => {
                        if (winner.id === playerIndex) {
                            let m = parseInt(localStorage.getItem('feistos_money')||0);
                            localStorage.setItem('feistos_money', m + 1000); 
                            alert("CONGRATULATIONS! You won $1000!");
                        } else {
                            alert("You lost! Better luck next time.");
                        }
                    }, 500);
                }
            }
// --- –û–¢–†–ò–°–û–í–ö–ê –û–¢–°–ß–ï–¢–ê ---
        if (!raceStarted) {
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0); // –°–±—Ä–æ—Å –∫–∞–º–µ—Ä—ã (—Ä–∏—Å—É–µ–º –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ)
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#fff';
            ctx.font = '900 150px "Arial Black", sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            let text = raceCountdown > 0 ? raceCountdown : "GO!";
            // –¶–≤–µ—Ç–∞ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
            if (text === "GO!") ctx.fillStyle = "#33ff33";
            else if (text == 1) ctx.fillStyle = "#ffff00";
            else if (text == 2) ctx.fillStyle = "#ffaa00";
            else ctx.fillStyle = "#ff0055";

            ctx.shadowBlur = 20;
            ctx.shadowColor = ctx.fillStyle;
            
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            ctx.shadowBlur = 0;
            ctx.restore();
        }
        }

        draw();
// --- –û–¢–†–ò–°–û–í–ö–ê –û–¢–°–ß–ï–¢–ê ---
        if (!raceStarted) {
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0); // –°–±—Ä–æ—Å –∫–∞–º–µ—Ä—ã (—Ä–∏—Å—É–µ–º –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ)
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#fff';
            ctx.font = '900 150px "Arial Black", sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            let text = raceCountdown > 0 ? raceCountdown : "GO!";
            // –¶–≤–µ—Ç–∞ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
            if (text === "GO!") ctx.fillStyle = "#33ff33";
            else if (text == 1) ctx.fillStyle = "#ffff00";
            else if (text == 2) ctx.fillStyle = "#ffaa00";
            else ctx.fillStyle = "#ff0055";

            ctx.shadowBlur = 20;
            ctx.shadowColor = ctx.fillStyle;
            
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            ctx.shadowBlur = 0;
            ctx.restore();
        }
        requestAnimationFrame(update);
    }

    // ==========================================
    // –û–¢–†–ò–°–û–í–ö–ê
    // ==========================================
    function draw() {
        ctx.fillStyle = '#050505';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.scale(camera.zoom, camera.zoom);
        ctx.translate(-camera.x, -camera.y);

        // –¢—Ä–∞—Å—Å–∞
        ctx.lineJoin = 'round'; ctx.lineCap = 'round';
        ctx.beginPath();
        trackPoints.forEach((p, i) => { i===0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y); });
        ctx.closePath();
        
        ctx.lineWidth = trackWidth + 40; ctx.strokeStyle = '#222'; ctx.stroke();
        ctx.lineWidth = trackWidth; ctx.strokeStyle = '#111'; ctx.stroke();
        
        // –õ–∏–Ω–∏—è —Ñ–∏–Ω–∏—à–∞
        ctx.save();
        let p0 = trackPoints[0], p1 = trackPoints[1];
        ctx.translate(p0.x, p0.y);
        ctx.rotate(Math.atan2(p1.y-p0.y, p1.x-p0.x));
        ctx.fillStyle = '#fff'; ctx.fillRect(0, -trackWidth/2, 40, trackWidth); // –ü–æ—à–∏—Ä–µ
        ctx.restore();

        // –°—Ç—Ä–µ–ª–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (GPS) –¥–ª—è –∏–≥—Ä–æ–∫–∞
        if (isHumanPlaying && !cars[playerIndex].finished) {
            let car = cars[playerIndex];
            let nextP = trackPoints[car.targetIndex];
            ctx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(car.x, car.y);
            ctx.lineTo(nextP.x, nextP.y);
            ctx.stroke();
        }

        // –ú–∞—à–∏–Ω—ã
        cars.forEach(car => {
            ctx.save();
            ctx.translate(car.x, car.y);
            ctx.rotate(car.angle);
            ctx.shadowColor = car.color; ctx.shadowBlur = 15;
            
            // –ö–æ—Ä–ø—É—Å
            ctx.fillStyle = car.color; 
            ctx.fillRect(-16, -10, 32, 20);
            
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏–≥—Ä–æ–∫–∞
            if (car.id === playerIndex) {
                ctx.fillStyle = '#fff'; 
                ctx.beginPath(); ctx.moveTo(0,-15); ctx.lineTo(-5,-25); ctx.lineTo(5,-25); ctx.fill();
                // –§–∞—Ä—ã —Å–≤–µ—Ç—è—Ç
                ctx.fillStyle = 'rgba(255, 255, 200, 0.5)';
                ctx.beginPath();
                ctx.moveTo(16, -8); ctx.lineTo(150, -40); ctx.lineTo(150, 40); ctx.lineTo(16, 8);
                ctx.fill();
            }
            ctx.restore();
        });
        ctx.restore();
        
        // –ú–∏–Ω–∏-—Ä–∞–¥–∞—Ä
        const mmW = 200; const mmH = 150; 
        const mmX = canvas.width - mmW - 20; const mmY = 50; 
        const scaleX = mmW / mapWidth; const scaleY = mmH / mapHeight;

        ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.strokeStyle = '#00ffff'; ctx.lineWidth = 2;
        ctx.fillRect(mmX, mmY, mmW, mmH); ctx.strokeRect(mmX, mmY, mmW, mmH);

        ctx.beginPath(); ctx.strokeStyle = '#555'; ctx.lineWidth = 2;
        trackPoints.forEach((p, i) => {
            let px = mmX + p.x * scaleX; let py = mmY + p.y * scaleY;
            if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
        });
        ctx.stroke();

        cars.forEach(car => {
            let cx = mmX + car.x * scaleX; let cy = mmY + car.y * scaleY;
            ctx.fillStyle = (car.id === playerIndex) ? '#fff' : car.color;
            ctx.beginPath(); ctx.arc(cx, cy, (car.id === playerIndex ? 4 : 2), 0, Math.PI*2); ctx.fill();
        });
    }

    update();
}

// ==========================================
// –ú–ò–ù–ò-–ò–ì–†–ê "SPIKE HELL" (SETTINGS & INFINITY UPDATE)
// ==========================================

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–∑ HTML –∫–Ω–æ–ø–æ–∫
window.startSpikeGame = function(id, mode) {
    const canvas = document.getElementById(`spikeCanvas-${id}`);
    if (!canvas) return;
    
    // –°—á–∏—Ç—ã–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    const pColorInput = document.getElementById(`p-color-${id}`);
    const sColorInput = document.getElementById(`s-color-${id}`);
    
    const pColor = pColorInput ? pColorInput.value : '#ffffff';
    const sColor = sColorInput ? sColorInput.value : '#ff0000';

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    localStorage.setItem('feistos_spike_p_color', pColor);
    localStorage.setItem('feistos_spike_s_color', sColor);

    // –í—ã–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    initSpikeGameLogic(id, mode, pColor, sColor);
};

// –ü—É—Å—Ç—ã—à–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ (–µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å)
function initSpikeGame(id) {
    // –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é, —Å–±—Ä–∞—Å—ã–≤–∞—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    const menu = document.getElementById(`spike-menu-${id}`);
    const ui = document.getElementById(`spike-ui-${id}`);
    const btns = document.getElementById(`menu-buttons-${id}`);
    const settings = document.getElementById(`settings-panel-${id}`);
    const gameOver = document.getElementById(`game-over-content-${id}`);
    
    if(menu) {
        menu.style.display = 'flex';
        btns.style.display = 'flex';
        settings.style.display = 'none';
        gameOver.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω –ø—Ä–æ–∏–≥—Ä—ã—à–∞
    }
    if(ui) ui.style.display = 'none';
    
    // –†–∏—Å—É–µ–º –æ–¥–∏–Ω –∫–∞–¥—Ä —Ñ–æ–Ω–∞
    const canvas = document.getElementById(`spikeCanvas-${id}`);
    if(canvas) {
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#000';
        ctx.fillRect(0,0,canvas.width, canvas.height);
    }
}

// –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
function initSpikeGameLogic(id, mode, playerColor, spikeColor) {
    const canvas = document.getElementById(`spikeCanvas-${id}`);
    const menu = document.getElementById(`spike-menu-${id}`);
    const ui = document.getElementById(`spike-ui-${id}`);
    const timerEl = document.getElementById(`spike-timer-${id}`);
    const modeLabel = document.getElementById(`spike-mode-label-${id}`);
    const gameOverContainer = document.getElementById(`game-over-content-${id}`);
    const menuButtons = document.getElementById(`menu-buttons-${id}`);

    if (!canvas) return;

    // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    menu.style.display = 'none';
    menuButtons.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –ø–æ–∫–∞ –∏–≥—Ä–∞–µ–º
    gameOverContainer.innerHTML = '';   // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–µ–∫—Å—Ç
    ui.style.display = 'block';
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –¥–ª—è –∏–≥—Ä—ã
    canvas.parentElement.style.cursor = 'none';

    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É —Ä–µ–∂–∏–º–∞
    modeLabel.textContent = (mode === 'infinity') ? "[INFINITY MODE]" : "[SURVIVAL MODE]";

    function resizeGame() {
        if (!canvas.parentElement) return;
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
    }
    resizeGame();
    
    const ctx = canvas.getContext('2d');

    // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
    let isRunning = true;
    let gameTime = 0;
    let frameCount = 0;
    
    const player = { 
        x: canvas.width / 2, 
        y: canvas.height / 2, 
        radius: 10,
        color: playerColor
    };

    let spikes = [];
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—ã—à—å—é
    const onMouseMove = (e) => {
        const rect = canvas.getBoundingClientRect();
        player.x = e.clientX - rect.left;
        player.y = e.clientY - rect.top;
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
        if (player.x < player.radius) player.x = player.radius;
        if (player.x > canvas.width - player.radius) player.x = canvas.width - player.radius;
        if (player.y < player.radius) player.y = player.radius;
        if (player.y > canvas.height - player.radius) player.y = canvas.height - player.radius;
    };
    canvas.addEventListener('mousemove', onMouseMove);

    // --- –§–ò–ö–° –§–ü–° ---
    let lastTime = 0;
    const fpsInterval = 1000 / 60;
    let animationFrameId;

    function loop(timestamp) {
        if (!isRunning) return;
        animationFrameId = requestAnimationFrame(loop);

        const elapsed = timestamp - lastTime;
        if (elapsed > fpsInterval) {
            lastTime = timestamp - (elapsed % fpsInterval);
            update();
            draw();
        }
    }

    function update() {
        gameTime += 1/60;
        timerEl.textContent = gameTime.toFixed(2);
        
        // --- –õ–û–ì–ò–ö–ê –ü–û–ë–ï–î–´ ---
        if (mode === 'survival' && gameTime >= 60) {
            endGame(true);
            return;
        }

        // --- –°–õ–û–ñ–ù–û–°–¢–¨ (–ë–∞–ª–∞–Ω—Å) ---
        let spawnRate, spikeSpeed;

        if (mode === 'survival') {
            // –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º (0-60 —Å–µ–∫)
            spawnRate = 40; spikeSpeed = 5;
            if (gameTime > 10) { spawnRate = 30; spikeSpeed = 7; }
            if (gameTime > 20) { spawnRate = 20; spikeSpeed = 9; }
            if (gameTime > 30) { spawnRate = 10; spikeSpeed = 12; }
            if (gameTime > 45) { spawnRate = 5;  spikeSpeed = 15; } 
            if (gameTime > 55) { spawnRate = 3;  spikeSpeed = 20; }
        } else {
            // INFINITY MODE (–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ —É—Å–ª–æ–∂–Ω–µ–Ω–∏–µ)
            // –§–æ—Ä–º—É–ª–∞: —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞—Å—Ç–µ—Ç –ª–∏–Ω–µ–π–Ω–æ, —Å–ø–∞–≤–Ω —Ä–µ–π—Ç —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∏
            // –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å—Ç–∞–Ω–µ—Ç —Å–æ–≤—Å–µ–º –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã–º (–∫–∞–ø –Ω–∞ 2 –∫–∞–¥—Ä–∞—Ö), –Ω–æ –±—É–¥–µ—Ç –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–º
            spikeSpeed = 5 + (gameTime * 0.3); // –ö–∞–∂–¥—ã–µ 10 —Å–µ–∫ +3 –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏
            spawnRate = Math.max(2, Math.floor(40 - (gameTime * 0.5))); // –£–º–µ–Ω—å—à–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Å–ø–∞–≤–Ω–∞
        }

        frameCount++;
        if (frameCount % spawnRate === 0) {
            spawnSpike(spikeSpeed);
        }

        // –õ–æ–≥–∏–∫–∞ —à–∏–ø–æ–≤
        for (let i = spikes.length - 1; i >= 0; i--) {
            let s = spikes[i];
            s.x += s.vx;
            s.y += s.vy;
            s.rotation += 0.1;

            // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ (—Å –∑–∞–ø–∞—Å–æ–º –¥–ª—è –≤—ã—Å–æ–∫–∏—Ö —Å–∫–æ—Ä–æ—Å—Ç–µ–π)
            if (s.x < -200 || s.x > canvas.width + 200 || s.y < -200 || s.y > canvas.height + 200) {
                spikes.splice(i, 1);
                continue;
            }

            // –ö–æ–ª–ª–∏–∑–∏—è
            let dx = player.x - s.x;
            let dy = player.y - s.y;
            let dist = Math.sqrt(dx*dx + dy*dy);

            if (dist < player.radius + s.size * 0.6) {
                endGame(false);
            }
        }
    }

    function spawnSpike(speed) {
        let x, y;
        const side = Math.floor(Math.random() * 4); 
        const buffer = 50;

        if (side === 0) { x = Math.random() * canvas.width; y = -buffer; }
        else if (side === 1) { x = canvas.width + buffer; y = Math.random() * canvas.height; }
        else if (side === 2) { x = Math.random() * canvas.width; y = canvas.height + buffer; }
        else { x = -buffer; y = Math.random() * canvas.height; }

        // –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ/–ù–∞–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –∏–≥—Ä–æ–∫–∞
        const angle = Math.atan2(player.y - y, player.x - x);
        
        // –í –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–º–Ω–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ä–∞–∑–±—Ä–æ—Å–∞ –Ω–∞ –≤—ã—Å–æ–∫–∏—Ö —É—Ä–æ–≤–Ω—è—Ö, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–µ—Å–µ–ª–µ–µ
        let angleOffset = 0;
        if (mode === 'infinity' && gameTime > 30) {
             angleOffset = (Math.random() - 0.5) * 0.2;
        }

        spikes.push({
            x: x, y: y,
            vx: Math.cos(angle + angleOffset) * speed,
            vy: Math.sin(angle + angleOffset) * speed,
            size: 15 + Math.random() * 10,
            color: spikeColor, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç
            rotation: Math.random() * Math.PI
        });
    }

    function draw() {
        // –û—á–∏—Å—Ç–∫–∞ —Å –ª–µ–≥–∫–∏–º —à–ª–µ–π—Ñ–æ–º
        ctx.fillStyle = 'rgba(10, 0, 0, 0.3)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –ò–≥—Ä–æ–∫
        ctx.shadowBlur = 20;
        ctx.shadowColor = player.color;
        ctx.fillStyle = player.color;
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;

        // –®–∏–ø—ã
        spikes.forEach(s => {
            ctx.save();
            ctx.translate(s.x, s.y);
            ctx.rotate(s.rotation);
            ctx.fillStyle = s.color;
            ctx.shadowBlur = 10;
            ctx.shadowColor = s.color;
            ctx.beginPath();
            ctx.moveTo(s.size, 0);
            ctx.lineTo(-s.size/2, s.size/2);
            ctx.lineTo(-s.size/2, -s.size/2);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        });
        
        // –≠—Ñ—Ñ–µ–∫—Ç —Ä–∞–º–∫–∏ –ø—Ä–∏ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        if ((mode === 'survival' && gameTime > 50) || (mode === 'infinity' && gameTime > 60)) {
            ctx.strokeStyle = `rgba(255, 0, 0, ${(gameTime % 1)})`;
            ctx.lineWidth = 10;
            ctx.strokeRect(0,0,canvas.width, canvas.height);
        }
    }

    function endGame(win) {
        isRunning = false;
        cancelAnimationFrame(animationFrameId);
        canvas.removeEventListener('mousemove', onMouseMove);
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—É—Ä—Å–æ—Ä
        canvas.parentElement.style.cursor = 'default';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
        menu.style.display = 'flex';
        ui.style.display = 'none';

        let html = '';

        if (win) {
            // –ü–û–ë–ï–î–ê (–¢–æ–ª—å–∫–æ –≤ Survival)
            let m = parseInt(localStorage.getItem('feistos_money')||0);
            localStorage.setItem('feistos_money', m + 5000); 
            
            html = `
                <h1 style="color: #00ff00; font-size: 4rem; text-shadow: 0 0 20px #00ff00;">SURVIVED</h1>
                <p style="color: #fff;">System Defeated. +$5000</p>
            `;
        } else {
            // –ü–†–û–ò–ì–†–´–®
            const titleColor = (mode === 'infinity') ? '#9b59b6' : '#ff0000';
            const titleText = (mode === 'infinity') ? 'OBLITERATED' : 'DEAD';

// --- –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ö–û–†–î–ê ---
            let recordText = "";
            if (mode === 'infinity') {
                let best = parseFloat(localStorage.getItem('feistos_infinity_best') || 0);
                if (gameTime > best) {
                    best = gameTime;
                    localStorage.setItem('feistos_infinity_best', best);
                    recordText = `<br><span style="color: #33ff33; font-weight: bold; font-size: 1.2rem;">‚òÖ NEW RECORD ‚òÖ</span>`;
                }
                recordText += `<br><span style="color: #aaa; font-size: 1rem;">BEST TIME: ${best.toFixed(2)}s</span>`;
            }
            // ---------------------------
            
            html = `
                <h1 style="color: ${titleColor}; font-size: 4rem; text-shadow: 0 0 20px ${titleColor};">${titleText}</h1>
                <p style="color: #fff; font-size: 1.5rem;">Time: ${gameTime.toFixed(2)}s</p>
            `;
            
            if (mode === 'survival') {
                html += `<p style="color: #666;">Need 60.00s to win</p>`;
            } else {
                html += `<p style="color: #ccc;">Infinity Mode Run ${recordText}</p>`;
            }
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"
        html += `<button onclick="initSpikeGame(${id})" style="margin-top: 20px; padding: 15px 40px; background: #fff; color: black; border: none; font-weight: bold; cursor: pointer;">MAIN MENU</button>`;

        gameOverContainer.innerHTML = html;
        gameOverContainer.style.display = 'block';
    }

    // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞
    requestAnimationFrame(loop);
}

</script>
</body>
</html>
